<!DOCTYPE html>
<html :lang="lang" x-data="app()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="t('app.title')">ITSG-33 Accreditation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -10px rgba(0,0,0,0.2);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .markdown-content h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1e3a5f; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #2d5a87; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #374151; }
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content li { margin-bottom: 0.25rem; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .markdown-content th { background-color: #f3f4f6; font-weight: 600; }
        .markdown-content .status-implemented { color: #059669; }
        .markdown-content .status-partial { color: #d97706; }
        .markdown-content .status-not-implemented { color: #dc2626; }
        .markdown-content .severity-critical { background-color: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-high { background-color: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-medium { background-color: #fef9c3; color: #854d0e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-low { background-color: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content blockquote { margin: 0.5rem 0; padding: 0.75rem; background: #f9fafb; border-left: 3px solid #9ca3af; font-style: italic; font-size: 0.9rem; }
        /* Evidence Strength Badges */
        .strength-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        .strength-1 { background: #dcfce7; color: #166534; }  /* System Generated - Green */
        .strength-2 { background: #d1fae5; color: #065f46; }  /* IaC - Teal */
        .strength-3 { background: #dbeafe; color: #1e40af; }  /* Automated Test - Blue */
        .strength-4 { background: #e0e7ff; color: #4338ca; }  /* Code - Indigo */
        .strength-5 { background: #fef9c3; color: #854d0e; }  /* Screenshot - Yellow */
        .strength-6 { background: #fed7aa; color: #c2410c; }  /* Video - Orange */
        .strength-7 { background: #fee2e2; color: #991b1b; }  /* Narrative - Red */
        .machine-verifiable-badge { color: #059669; font-size: 0.65rem; }
        .human-curated-badge { color: #d97706; font-size: 0.65rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Top Utility Bar -->
    <div class="bg-gray-900 text-white text-[0.7rem] py-1.5 px-4 sm:px-6 lg:px-8 flex justify-end items-center space-x-4">
        <button @click="setLang('en')" class="hover:text-blue-300 transition-all uppercase tracking-widest" :class="lang === 'en' ? 'font-bold text-blue-400' : 'text-gray-400'">English</button>
        <span class="text-gray-700">|</span>
        <button @click="setLang('fr')" class="hover:text-blue-300 transition-all uppercase tracking-widest" :class="lang === 'fr' ? 'font-bold text-blue-400' : 'text-gray-400'">Fran√ßais</button>
    </div>

    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img src="/static/aip.png" alt="Logo" class="h-10 w-auto mr-3 rounded">
                        <div>
                            <span class="font-bold text-xl" x-text="t('app.name')">ITSG-33 Accreditation</span>
                            <span class="text-xs text-blue-200 block" x-text="t('app.subtitle')">Security Assessment Platform</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-blue-200 hidden md:inline-flex items-center bg-white/5 px-3 py-1 rounded-full border border-white/10">
                        <i class="fas fa-circle text-green-400 text-[0.5rem] mr-2 pulse-dot"></i>
                        <span x-text="t('app.system_operational')">System Operational</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button @click="currentTab = 'dashboard'"
                        :class="currentTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-tachometer-alt mr-2"></i><span x-text="t('nav.dashboard')">Dashboard</span>
                </button>
                <button @click="currentTab = 'new'"
                        :class="currentTab === 'new' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i><span x-text="t('nav.new_assessment')">New Assessment</span>
                </button>
                <button @click="currentTab = 'assessments'"
                        :class="currentTab === 'assessments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-list mr-2"></i><span x-text="t('nav.assessments')">Assessments</span>
                </button>
                <button @click="currentTab = 'controls'"
                        :class="currentTab === 'controls' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-lock mr-2"></i><span x-text="t('nav.controls')">Control Families</span>
                </button>
                <button @click="currentTab = 'help'"
                        :class="currentTab === 'help' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-life-ring mr-2"></i><span x-text="t('nav.help')">Help</span>
                </button>
            </nav>
        </div>

        <!-- Dashboard Tab -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-clipboard-check text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500" x-text="t('stats.total_assessments')">Total Assessments</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500" x-text="t('stats.completed')">Completed</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.filter(a => a.status === 'completed').length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-spinner text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500" x-text="t('stats.in_progress')">In Progress</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.filter(a => a.status === 'in_progress' || a.status === 'running').length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-shield-alt text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500" x-text="t('stats.control_families')">Control Families</p>
                            <p class="text-2xl font-bold text-gray-900">17</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Assessments -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-history mr-2 text-gray-400"></i><span x-text="t('dashboard.recent_assessments')">Recent Assessments</span>
                </h3>
                <div x-show="assessments.length === 0" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p x-text="t('dashboard.empty_assessments')">No assessments yet. Create your first assessment to get started.</p>
                    <button @click="currentTab = 'new'" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i><span x-text="t('dashboard.create_assessment')">Create Assessment</span>
                    </button>
                </div>
                <div x-show="assessments.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('table.project')">Project</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('table.client')">Client</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('table.status')">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('table.created')">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="t('table.actions')">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="assessment in assessments.slice(0, 5)" :key="assessment.assessment_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="assessment.project_name"></div>
                                        <div class="text-sm text-gray-500" x-text="assessment.assessment_id.slice(0, 8) + '...'"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="assessment.client_id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="getStatusClass(assessment.status)" class="px-2 py-1 text-xs font-medium rounded-full" x-text="getStatusLabel(assessment.status)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(assessment.created_at)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewAssessment(assessment.assessment_id)" class="text-blue-600 hover:text-blue-800 mr-3">
                                            <i class="fas fa-eye"></i> <span x-text="t('action.view')">View</span>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Assessment Tab -->
        <div x-show="currentTab === 'new'" x-cloak>
            <div class="bg-white rounded-xl shadow-md p-8 max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    <i class="fas fa-plus-circle mr-2 text-blue-600"></i><span x-text="t('assessment.new_title')">Create New Assessment</span>
                </h2>

                <!-- Step Indicator -->
                <div class="flex items-center mb-8">
                    <div class="flex items-center">
                        <div :class="step >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 1 ? 'text-blue-600' : 'text-gray-500'" x-text="t('step.details')">Details</span>
                    </div>
                    <div class="flex-1 h-1 mx-4" :class="step >= 2 ? 'bg-blue-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 2 ? 'text-blue-600' : 'text-gray-500'" x-text="t('step.documents')">Documents</span>
                    </div>
                    <div class="flex-1 h-1 mx-4" :class="step >= 3 ? 'bg-blue-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 3 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">3</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 3 ? 'text-blue-600' : 'text-gray-500'" x-text="t('step.run')">Run</span>
                    </div>
                </div>

                <!-- Step 1: Details -->
                <div x-show="step === 1">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('form.client_id')">Client ID *</label>
                            <input type="text" x-model="newAssessment.client_id"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   :placeholder="t('form.client_placeholder')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('form.project_name')">Project Name *</label>
                            <input type="text" x-model="newAssessment.project_name"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   :placeholder="t('form.project_placeholder')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('form.conops')">Concept of Operations (CONOPS)</label>
                            <textarea x-model="newAssessment.conops" rows="5"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                      :placeholder="t('form.conops_placeholder')"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button @click="createAssessment()"
                                    :disabled="!newAssessment.client_id || !newAssessment.project_name"
                                    :class="(!newAssessment.client_id || !newAssessment.project_name) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                                    class="px-6 py-3 text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i><span x-text="t('button.continue_documents')">Continue to Documents</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Documents -->
                <div x-show="step === 2">
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span x-text="t('docs.info')">Upload security documentation including policies, procedures, architecture diagrams, and configuration evidence.</span>
                            </p>
                        </div>

                        <!-- Drop Zone -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors"
                             @dragover.prevent="dragover = true"
                             @dragleave.prevent="dragover = false"
                             @drop.prevent="handleDrop($event)"
                             :class="dragover ? 'border-blue-500 bg-blue-50' : ''">
                            <input type="file" multiple @change="handleFiles($event)" class="hidden" id="fileInput" accept=".pdf,.docx,.doc,.txt,.md,.log,.png,.jpg,.jpeg,.mp4,.mov,.avi,.zip,.tar,.gz">
                            <label for="fileInput" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">
                                    <span x-text="t('docs.drag_drop')">Drag and drop files here, or</span>
                                    <span class="text-blue-600 font-medium" x-text="t('docs.browse')">browse</span>
                                </p>
                                <p class="text-sm text-gray-400 mt-2" x-text="t('docs.supports')">Supports PDF, DOCX, TXT, PNG, JPG</p>
                            </label>
                        </div>

                        <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-4 py-3">
                            <div class="text-sm text-gray-700">
                                <span class="font-medium" x-text="t('docs.auto_upload') || 'Auto-upload'">Auto-upload</span>
                                <span class="text-gray-400 ml-2" x-text="t('docs.auto_upload_hint') || 'Upload immediately after selection'">Upload immediately after selection</span>
                            </div>
                            <button @click="autoUpload = !autoUpload"
                                    :class="autoUpload ? 'bg-blue-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                <span :class="autoUpload ? 'translate-x-6' : 'translate-x-1'" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </div>

                        <!-- Pending Files List -->
                        <div x-show="pendingFiles.length > 0" class="space-y-3">
                            <h4 class="font-medium text-gray-700" x-text="t('docs.pending_files') || 'Pending Documents:'">Pending Documents:</h4>
                            <template x-for="(pf, index) in pendingFiles" :key="index">
                                <div class="flex flex-col bg-white border border-gray-200 rounded-lg p-3 shadow-sm space-y-2">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                                            <span class="text-sm text-gray-800 font-medium" x-text="pf.filename"></span>
                                        </div>
                                        <button @click="pendingFiles.splice(index, 1)" class="text-gray-400 hover:text-red-500">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <input type="text" x-model="pf.significance_note" 
                                           class="w-full text-xs px-3 py-2 border border-gray-200 rounded-md focus:ring-1 focus:ring-blue-500 bg-gray-50"
                                           :placeholder="t('docs.significance_placeholder') || 'Optional: Tell the AI what is significant about this file...'">
                                </div>
                            </template>
                        </div>

                        <!-- Already Uploaded Files List -->
                        <div x-show="uploadedFiles.length > 0" class="space-y-2">
                            <h4 class="font-medium text-gray-500 text-sm" x-text="t('docs.uploaded_files')">Uploaded Files:</h4>
                            <template x-for="(file, index) in uploadedFiles" :key="index">
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 space-y-2">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3 text-xs"></i>
                                            <span class="text-xs text-gray-700 font-medium" x-text="file.filename"></span>
                                            <span x-show="file.type === 'iac'" class="ml-2 px-1.5 py-0.5 bg-purple-100 text-purple-700 text-[0.6rem] font-bold rounded uppercase">IaC</span>
                                            <span x-show="file.type === 'code'" class="ml-2 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-[0.6rem] font-bold rounded uppercase">Code</span>
                                            <span x-show="file.source_archive" class="ml-2 px-1.5 py-0.5 bg-gray-100 text-gray-500 text-[0.6rem] font-semibold rounded" x-text="file.source_archive"></span>
                                        </div>
                                        <button x-show="file.file_id" @click="startEditComment(file)" class="text-xs text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit mr-1"></i><span x-text="t('docs.edit_comment')">Edit</span>
                                        </button>
                                    </div>

                                    <div x-show="editingFileId !== file.file_id" class="text-[0.7rem] text-gray-500">
                                        <span class="font-semibold" x-text="t('docs.comment_label') || 'Comment:'">Comment:</span>
                                        <span x-text="file.significance_note || t('docs.no_comment')"></span>
                                    </div>

                                    <div x-show="editingFileId === file.file_id" class="space-y-2">
                                        <input type="text" x-model="editingNote" class="w-full text-xs px-3 py-2 border border-gray-200 rounded-md focus:ring-1 focus:ring-blue-500 bg-white"
                                               :placeholder="t('docs.significance_placeholder')">
                                        <div class="flex items-center space-x-2">
                                            <button @click="saveEditComment(file)" class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                <span x-text="t('docs.save')">Save</span>
                                            </button>
                                            <button @click="cancelEditComment()" class="px-3 py-1.5 text-xs border border-gray-300 text-gray-600 rounded-md hover:bg-gray-100">
                                                <span x-text="t('docs.cancel')">Cancel</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button @click="step = 1" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i><span x-text="t('button.back')">Back</span>
                            </button>
                            <button @click="uploadPendingFiles()" 
                                    :disabled="pendingFiles.length === 0 && uploadedFiles.length === 0"
                                    :class="(pendingFiles.length === 0 && uploadedFiles.length === 0) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                                    class="px-6 py-3 text-white rounded-lg font-medium transition-colors">
                                <span x-text="pendingFiles.length > 0 ? (t('button.upload_continue') || 'Upload & Continue') : t('button.continue')">Continue</span>
                                <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Run -->
                <div x-show="step === 3">
                    <div class="space-y-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="font-semibold text-green-800 mb-2">
                                <i class="fas fa-check-circle mr-2"></i><span x-text="t('run.ready_title')">Ready to Run Assessment</span>
                            </h4>
                            <div class="text-sm text-green-700 space-y-1">
                                <p><strong x-text="t('run.assessment_id')">Assessment ID:</strong> <span x-text="currentAssessmentId"></span></p>
                                <p><strong x-text="t('run.project')">Project:</strong> <span x-text="newAssessment.project_name"></span></p>
                                <p><strong x-text="t('run.documents')">Documents:</strong> <span x-text="uploadedFiles.length"></span> <span x-text="t('run.files_uploaded')">files uploaded</span></p>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span x-text="t('run.warning')">The assessment will analyze your documents against all 17 ITSG-33 control families. This may take several minutes.</span>
                            </p>
                        </div>

                        <div class="flex justify-between">
                            <button @click="step = 2" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i><span x-text="t('button.back')">Back</span>
                            </button>
                            <button @click="runAssessment()"
                                    :disabled="isRunning"
                                    :class="isRunning ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                                    class="px-6 py-3 text-white rounded-lg font-medium transition-colors">
                                <template x-if="!isRunning">
                                    <span><i class="fas fa-play mr-2"></i><span x-text="t('button.run_assessment')">Run Assessment</span></span>
                                </template>
                                <template x-if="isRunning">
                                    <span><i class="fas fa-spinner fa-spin mr-2"></i><span x-text="t('button.running')">Running...</span></span>
                                </template>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessments Tab -->
        <div x-show="currentTab === 'assessments'" x-cloak>
            <div class="bg-white rounded-xl shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-list mr-2 text-gray-400"></i><span x-text="t('assessments.title')">All Assessments</span>
                        </h2>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <span x-text="t('assessments.show_deleted')">Show deleted</span>
                                <button @click="showDeleted = !showDeleted"
                                        :class="showDeleted ? 'bg-blue-600' : 'bg-gray-200'"
                                        class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors">
                                    <span :class="showDeleted ? 'translate-x-5' : 'translate-x-1'" class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"></span>
                                </button>
                            </div>
                            <button @click="loadAssessments()" class="px-4 py-2 text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-sync-alt mr-1"></i><span x-text="t('assessments.refresh')">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="assessments.length === 0" class="p-8 text-center text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-3"></i>
                    <p x-text="t('assessments.empty')">No assessments found.</p>
                </div>

                <div x-show="assessments.length > 0" class="divide-y divide-gray-200">
                    <template x-for="assessment in assessments" :key="assessment.assessment_id">
                        <div class="p-6 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="text-lg font-medium text-gray-900" x-text="assessment.project_name"></h3>
                                        <span :class="assessment.deleted ? 'bg-gray-200 text-gray-600' : getStatusClass(assessment.status)"
                                              class="ml-3 px-2 py-1 text-xs font-medium rounded-full"
                                              x-text="assessment.deleted ? t('assessments.deleted') : getStatusLabel(assessment.status)"></span>
                                    </div>
                                    <div class="mt-1 text-sm text-gray-500">
                                        <span><i class="fas fa-building mr-1"></i><span x-text="assessment.client_id"></span></span>
                                        <span class="mx-2">|</span>
                                        <span><i class="fas fa-calendar mr-1"></i><span x-text="formatDate(assessment.created_at)"></span></span>
                                        <span class="mx-2">|</span>
                                        <span class="text-xs text-gray-400" x-text="assessment.assessment_id"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button x-show="!assessment.deleted" @click="viewAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                                        <i class="fas fa-eye mr-1"></i><span x-text="t('action.view')">View</span>
                                    </button>
                                    <button x-show="!assessment.deleted && assessment.status === 'created'"
                                            @click="selectAssessmentForRun(assessment)"
                                            class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                                        <i class="fas fa-play mr-1"></i><span x-text="t('action.run')">Run</span>
                                    </button>
                                    <button x-show="!assessment.deleted && assessment.status === 'completed'"
                                            @click="addDocumentsToAssessment(assessment)"
                                            class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm">
                                        <i class="fas fa-file-upload mr-1"></i><span x-text="t('action.add_docs')">Add Docs</span>
                                    </button>
                                    <button x-show="!assessment.deleted && assessment.status === 'completed'"
                                            @click="rerunAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm">
                                        <i class="fas fa-redo mr-1"></i><span x-text="t('action.rerun')">Rerun</span>
                                    </button>
                                    <button x-show="!assessment.deleted && assessment.status === 'completed'"
                                            @click="viewHistory(assessment.assessment_id)"
                                            class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm">
                                        <i class="fas fa-history mr-1"></i><span x-text="t('action.history')">History</span>
                                    </button>
                                    <button x-show="!assessment.deleted"
                                            @click="deleteAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm">
                                        <i class="fas fa-trash mr-1"></i><span x-text="t('action.delete')">Delete</span>
                                    </button>
                                    <button x-show="assessment.deleted"
                                            @click="restoreAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                                        <i class="fas fa-undo mr-1"></i><span x-text="t('action.restore')">Restore</span>
                                    </button>
                                    <button x-show="assessment.deleted"
                                            @click="purgeAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm">
                                        <i class="fas fa-skull-crossbones mr-1"></i><span x-text="t('action.purge')">Purge</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Control Families Tab -->
        <div x-show="currentTab === 'controls'" x-cloak>
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-lock mr-2 text-gray-400"></i><span x-text="t('controls.title')">ITSG-33 Control Families</span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="family in controlFamilies" :key="family.code">
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                                    <span x-text="family.code"></span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-medium text-gray-900" x-text="getControlFamilyName(family.code)"></h4>
                                    <p class="text-sm text-gray-500" x-text="getControlFamilyLabel(family.code)"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Profiles -->
            <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-layer-group mr-2 text-gray-400"></i><span x-text="t('controls.profiles_title')">Security Profiles</span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <template x-for="profile in profiles" :key="profile.number">
                        <div class="border-2 rounded-lg p-6 text-center"
                             :class="profile.number === 1 ? 'border-green-300 bg-green-50' : profile.number === 2 ? 'border-yellow-300 bg-yellow-50' : 'border-red-300 bg-red-50'">
                             <div class="text-3xl font-bold mb-2"
                                  :class="profile.number === 1 ? 'text-green-600' : profile.number === 2 ? 'text-yellow-600' : 'text-red-600'"
                                  x-text="formatProfileTitle(profile.number)"></div>
                             <div class="font-medium text-gray-900" x-text="getProfileLabel(profile.number)"></div>
                             <p class="text-sm text-gray-600 mt-2" x-text="getProfileDescription(profile.number)"></p>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Assessment Detail Modal -->
        <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showModal = false">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = false"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-5xl w-full mx-auto z-10 max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <div class="flex items-center">
                            <img src="/static/aip.png" alt="Logo" class="h-8 w-auto mr-3 rounded">
                            <h3 class="text-xl font-semibold text-gray-900">
                                <span x-text="t('report.assessment_report')">Assessment Report</span>
                            </h3>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 p-0.5 mr-2">
                                <button @click="reportLang = 'en'"
                                        :class="reportLang === 'en' ? 'bg-white shadow-sm text-blue-600 ring-1 ring-gray-200' : 'text-gray-400 hover:text-gray-600'"
                                        class="px-3 py-1.5 rounded-md text-xs font-bold transition-all uppercase">
                                    en
                                </button>
                                <button @click="reportLang = 'fr'"
                                        :class="reportLang === 'fr' ? 'bg-white shadow-sm text-blue-600 ring-1 ring-gray-200' : 'text-gray-400 hover:text-gray-600'"
                                        class="px-3 py-1.5 rounded-md text-xs font-bold transition-all uppercase">
                                    fr
                                </button>
                            </div>
                            <button @click="downloadMarkdown()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm" :title="t('report.download_markdown')">
                                <i class="fas fa-file-alt mr-1"></i>MD
                            </button>
                            <button @click="downloadWord()" x-show="selectedAssessment?.status === 'completed'" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm" :title="t('report.download_word')">
                                <i class="fas fa-file-word mr-1"></i>Word
                            </button>
                            <button @click="downloadPOAM()" x-show="selectedAssessment?.status === 'completed'" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm" :title="t('report.download_poam')">
                                <i class="fas fa-tasks mr-1"></i>POA&M
                            </button>
                            <button @click="showModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="selectedAssessment">
                            <div class="markdown-content" x-html="renderAssessmentReport()"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div x-show="showHistoryModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showHistoryModal = false">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showHistoryModal = false"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full mx-auto z-10 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-history mr-2 text-purple-600"></i><span x-text="t('history.title')">Assessment Run History</span>
                        </h3>
                        <button @click="showHistoryModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="assessmentHistory">
                            <div>
                                <p class="text-sm text-gray-600 mb-4">
                                    <span x-text="t('history.total_runs')">Total Runs:</span> <strong x-text="assessmentHistory.total_runs"></strong>
                                </p>

                                <!-- Current Run -->
                                <template x-if="assessmentHistory.current_run">
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-gray-800 mb-2" x-text="t('history.current_run')">Current Run</h4>
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="text-sm font-medium text-green-800"><span x-text="t('history.run_label')">Run</span> #<span x-text="assessmentHistory.current_run.run_id"></span></span>
                                                        <span class="px-2 py-1 bg-green-200 text-green-800 text-xs font-medium rounded-full" x-text="t('history.current_badge')">Current</span>
                                                    </div>
                                                    <p class="text-xs text-green-600">
                                                        <span x-text="t('history.completed')">Completed:</span> <span x-text="formatDate(assessmentHistory.current_run.completed_at)"></span>
                                                    </p>
                                                    <p class="text-xs text-green-600 mb-3">
                                                        <span x-text="t('history.documents')">Documents:</span> <span x-text="assessmentHistory.current_run.document_count"></span>
                                                    </p>
                                                    <!-- Controls Summary -->
                                                    <div class="bg-white rounded-lg p-3 border border-green-100">
                                                        <p class="text-xs font-semibold text-gray-700 mb-2" x-text="t('history.controls_summary')">Controls Summary</p>
                                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                                            <div>
                                                                <span class="text-gray-500" x-text="t('history.total_assessed')">Total Assessed:</span>
                                                                <span class="font-medium text-gray-800" x-text="assessmentHistory.current_run.total_controls || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500" x-text="t('history.full_evidence')">Full Evidence:</span>
                                                                <span class="font-medium text-green-600" x-text="assessmentHistory.current_run.controls_with_evidence || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500" x-text="t('history.partial')">Partial:</span>
                                                                <span class="font-medium text-yellow-600" x-text="assessmentHistory.current_run.controls_partial || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500" x-text="t('history.missing')">Missing:</span>
                                                                <span class="font-medium text-red-600" x-text="assessmentHistory.current_run.controls_missing || 0"></span>
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 pt-2 border-t border-green-100">
                                                            <div class="flex items-center justify-between">
                                                                <span class="text-xs text-gray-500" x-text="t('history.coverage')">Coverage:</span>
                                                                <span class="text-sm font-bold" :class="assessmentHistory.current_run.coverage_percentage >= 80 ? 'text-green-600' : assessmentHistory.current_run.coverage_percentage >= 50 ? 'text-yellow-600' : 'text-red-600'" x-text="(assessmentHistory.current_run.coverage_percentage || 0) + '%'"></span>
                                                            </div>
                                                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                                                <div class="h-1.5 rounded-full" :class="assessmentHistory.current_run.coverage_percentage >= 80 ? 'bg-green-500' : assessmentHistory.current_run.coverage_percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'" :style="'width: ' + (assessmentHistory.current_run.coverage_percentage || 0) + '%'"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Historical Runs -->
                                <template x-if="assessmentHistory.history && assessmentHistory.history.length > 0">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-2" x-text="t('history.previous_runs')">Previous Runs</h4>
                                        <div class="space-y-3">
                                            <template x-for="run in assessmentHistory.history" :key="run.run_id">
                                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                                    <div class="flex justify-between items-start">
                                                        <div class="flex-1">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <span class="text-sm font-medium text-gray-800"><span x-text="t('history.run_label')">Run</span> #<span x-text="run.run_id"></span></span>
                                                                <span class="px-2 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded-full" x-text="t('history.archived')">Archived</span>
                                                            </div>
                                                            <p class="text-xs text-gray-600">
                                                                <span x-text="t('history.completed')">Completed:</span> <span x-text="formatDate(run.completed_at)"></span>
                                                            </p>
                                                            <p class="text-xs text-gray-600 mb-3">
                                                                <span x-text="t('history.documents')">Documents:</span> <span x-text="run.document_count"></span>
                                                            </p>
                                                            <!-- Controls Summary -->
                                                            <div class="bg-white rounded-lg p-3 border border-gray-100">
                                                                <p class="text-xs font-semibold text-gray-700 mb-2" x-text="t('history.controls_summary')">Controls Summary</p>
                                                                <div class="grid grid-cols-2 gap-2 text-xs">
                                                                    <div>
                                                                        <span class="text-gray-500" x-text="t('history.total_assessed')">Total Assessed:</span>
                                                                        <span class="font-medium text-gray-800" x-text="run.total_controls || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500" x-text="t('history.full_evidence')">Full Evidence:</span>
                                                                        <span class="font-medium text-green-600" x-text="run.controls_with_evidence || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500" x-text="t('history.partial')">Partial:</span>
                                                                        <span class="font-medium text-yellow-600" x-text="run.controls_partial || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500" x-text="t('history.missing')">Missing:</span>
                                                                        <span class="font-medium text-red-600" x-text="run.controls_missing || 0"></span>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-2 pt-2 border-t border-gray-100">
                                                                    <div class="flex items-center justify-between">
                                                                        <span class="text-xs text-gray-500" x-text="t('history.coverage')">Coverage:</span>
                                                                        <span class="text-sm font-bold" :class="run.coverage_percentage >= 80 ? 'text-green-600' : run.coverage_percentage >= 50 ? 'text-yellow-600' : 'text-red-600'" x-text="(run.coverage_percentage || 0) + '%'"></span>
                                                                    </div>
                                                                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                                                        <div class="h-1.5 rounded-full" :class="run.coverage_percentage >= 80 ? 'bg-green-500' : run.coverage_percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'" :style="'width: ' + (run.coverage_percentage || 0) + '%'"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="!assessmentHistory.history || assessmentHistory.history.length === 0">
                                    <p class="text-gray-500 text-sm" x-text="t('history.none')">No previous runs. This is the first assessment run.</p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Documents Modal -->
        <div x-show="showAddDocsModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="closeAddDocsModal()">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeAddDocsModal()"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full mx-auto z-10 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-file-upload mr-2 text-indigo-600"></i><span x-text="t('add_docs.title')">Add Documents to Assessment</span>
                        </h3>
                        <button @click="closeAddDocsModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="addDocsAssessment">
                            <div>
                                <p class="text-sm text-gray-600 mb-4">
                                    <span x-text="t('add_docs.adding_documents')">Adding documents to:</span> <strong x-text="addDocsAssessment.project_name"></strong>
                                </p>

                                <!-- Drop Zone -->
                                <div class="border-2 border-dashed rounded-xl p-8 text-center transition-colors mb-6"
                                     :class="dragover ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300 hover:border-indigo-400'"
                                     @dragover.prevent="dragover = true"
                                     @dragleave.prevent="dragover = false"
                                     @drop.prevent="handleAddDocsDrop($event)">
                                    <i class="fas fa-cloud-upload-alt text-4xl mb-4" :class="dragover ? 'text-indigo-500' : 'text-gray-400'"></i>
                                    <p class="text-gray-600 mb-2" x-text="t('add_docs.drag_drop')">Drag & drop files here or</p>
                                    <label class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg cursor-pointer hover:bg-indigo-700 transition-colors">
                                        <i class="fas fa-folder-open mr-2"></i><span x-text="t('add_docs.browse')">Browse Files</span>
                                        <input type="file" multiple accept=".pdf,.docx,.doc,.txt,.md,.log,.png,.jpg,.jpeg,.mp4,.mov,.avi,.zip,.tar,.gz"
                                                class="hidden" @change="handleAddDocsFiles($event)">
                                    </label>
                                    <p class="text-xs text-gray-500 mt-3" x-text="t('add_docs.supported')">Supported: PDF, DOCX, TXT, PNG, JPG</p>
                                </div>

                                <!-- Uploaded Files List -->
                                <template x-if="addDocsFiles.length > 0">
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-gray-800 mb-2" x-text="t('add_docs.uploaded_files')">Uploaded Files</h4>
                                        <div class="space-y-2">
                                            <template x-for="file in addDocsFiles" :key="file.file_id">
                                                <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-file text-green-600 mr-3"></i>
                                                        <span class="text-sm text-gray-700" x-text="file.filename"></span>
                                                    </div>
                                                    <i class="fas fa-check-circle text-green-600"></i>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end space-x-3 flex-shrink-0">
                        <button @click="closeAddDocsModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <span x-text="t('add_docs.cancel')">Cancel</span>
                        </button>
                        <button @click="finishAddDocsAndRerun()"
                                :disabled="addDocsFiles.length === 0"
                                :class="addDocsFiles.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'"
                                class="px-4 py-2 text-white rounded-lg transition-colors">
                            <i class="fas fa-redo mr-2"></i><span x-text="t('add_docs.add_rerun')">Add & Rerun Assessment</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reject/Not Applicable Modal -->
        <div x-show="showRejectModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="closeRejectModal()">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeRejectModal()"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto z-10">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-xl">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <template x-if="rejectAction === 'not_applicable'">
                                <span><i class="fas fa-ban mr-2 text-blue-600"></i><span x-text="t('reject.not_applicable_title')">Mark Not Applicable</span></span>
                            </template>
                            <template x-if="rejectAction === 'reject_evidence'">
                                <span><i class="fas fa-times-circle mr-2 text-orange-600"></i><span x-text="t('reject.reject_evidence_title')">Reject Evidence</span></span>
                            </template>
                        </h3>
                        <button @click="closeRejectModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <template x-if="rejectingControl">
                            <div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong x-text="t('reject.control_id')">Control ID:</strong> <span class="font-mono text-gray-900" x-text="rejectingControl.control_id"></span>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong x-text="t('reject.control_name')">Control Name:</strong> <span x-text="rejectingControl.control_name"></span>
                                    </p>
                                </div>

                                <!-- Context message based on action -->
                                <div class="mb-4 p-4 rounded-lg"
                                     :class="rejectAction === 'not_applicable' ? 'bg-blue-50 border border-blue-200' : 'bg-orange-50 border border-orange-200'">
                                    <template x-if="rejectAction === 'not_applicable'">
                                        <p class="text-sm text-blue-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            <span x-text="t('reject.context_not_applicable')">This control will be marked as not applicable to this solution and excluded from coverage calculations.</span>
                                        </p>
                                    </template>
                                    <template x-if="rejectAction === 'reject_evidence'">
                                        <p class="text-sm text-orange-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            <span x-text="t('reject.context_reject')">The evidence will be rejected as insufficient. The control remains applicable and will need better documentation.</span>
                                        </p>
                                    </template>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span x-text="t('reject.reason')">Reason</span> <span class="text-red-500">*</span>
                                    </label>
                                    <textarea x-model="rejectReason" rows="3"
                                              class="w-full px-4 py-3 border rounded-lg focus:ring-2 transition-colors"
                                              :class="rejectError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-blue-500'"
                                              :placeholder="rejectAction === 'not_applicable' ? t('reject.placeholder_not_applicable') : t('reject.placeholder_reject')"></textarea>
                                    <p x-show="rejectError" class="mt-1 text-sm text-red-600" x-text="rejectError"></p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end space-x-3 rounded-b-xl">
                        <button @click="closeRejectModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <span x-text="t('reject.cancel')">Cancel</span>
                        </button>
                        <button @click="confirmRejectAction()"
                                class="px-4 py-2 text-white rounded-lg transition-colors"
                                :class="rejectAction === 'not_applicable' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-orange-600 hover:bg-orange-700'">
                            <i :class="rejectAction === 'not_applicable' ? 'fas fa-ban mr-2' : 'fas fa-times-circle mr-2'"></i>
                            <span x-text="rejectAction === 'not_applicable' ? t('reject.mark_not_applicable') : t('reject.reject_evidence')"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div x-show="toast.show" x-cloak
             x-transition:enter="transform ease-out duration-300 transition"
             x-transition:enter-start="translate-y-2 opacity-0"
             x-transition:enter-end="translate-y-0 opacity-100"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed bottom-4 right-4 z-50">
            <div :class="toast.type === 'success' ? 'bg-green-500' : toast.type === 'error' ? 'bg-red-500' : 'bg-blue-500'"
                 class="text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                <i :class="toast.type === 'success' ? 'fas fa-check-circle' : toast.type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle'" class="mr-2"></i>
                <span x-text="toast.message"></span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
            <p x-text="t('footer.text')">ITSG-33 Accreditation System &bull; Government of Canada IT Security Standard</p>
        </div>
    </footer>

    <script>
        function app() {
            return {
                lang: 'en',
                i18n: {
                    en: {
                        'app.title': 'ITSG-33 Accreditation System',
                        'app.name': 'ITSG-33 Accreditation',
                        'app.subtitle': 'Security Assessment Platform',
                        'app.system_operational': 'System Operational',
                        'nav.dashboard': 'Dashboard',
                        'nav.new_assessment': 'New Assessment',
                        'nav.assessments': 'Assessments',
                        'nav.controls': 'Control Families',
                        'stats.total_assessments': 'Total Assessments',
                        'stats.completed': 'Completed',
                        'stats.in_progress': 'In Progress',
                        'stats.control_families': 'Control Families',
                        'dashboard.recent_assessments': 'Recent Assessments',
                        'dashboard.empty_assessments': 'No assessments yet. Create your first assessment to get started.',
                        'dashboard.create_assessment': 'Create Assessment',
                        'table.project': 'Project',
                        'table.client': 'Client',
                        'table.status': 'Status',
                        'table.created': 'Created',
                        'table.actions': 'Actions',
                        'action.view': 'View',
                        'action.run': 'Run',
                        'action.add_docs': 'Add Docs',
                        'action.rerun': 'Rerun',
                        'action.history': 'History',
                        'action.delete': 'Delete',
                        'action.restore': 'Restore',
                        'action.purge': 'Purge',
                        'confirm.delete': 'Soft delete this assessment? You can restore it within 30 days.',
                        'confirm.purge': 'Permanently delete this assessment and all files? This cannot be undone.',
                        'toast.assessment_deleted': 'Assessment deleted',
                        'toast.assessment_restored': 'Assessment restored',
                        'toast.assessment_purged': 'Assessment permanently deleted',
                        'assessment.new_title': 'Create New Assessment',
                        'step.details': 'Details',
                        'step.documents': 'Documents',
                        'step.run': 'Run',
                        'form.client_id': 'Client ID *',
                        'form.project_name': 'Project Name *',
                        'form.conops': 'Concept of Operations (CONOPS)',
                        'form.client_placeholder': 'e.g., DEPT_001',
                        'form.project_placeholder': 'e.g., Cloud Migration Project',
                        'form.conops_placeholder': 'Describe the system purpose, data types processed, user base, and operational context...',
                        'button.continue_documents': 'Continue to Documents',
                        'docs.info': 'Upload security documentation including policies, procedures, architecture diagrams, and configuration evidence.',
                        'docs.drag_drop': 'Drag and drop files here, or',
                        'docs.browse': 'browse',
                        'docs.supports': 'Supports PDF, DOCX, TXT, MD, LOG, PNG, JPG, MP4, MOV, ZIP, TAR.GZ',
                        'docs.auto_upload': 'Auto-upload',
                        'docs.auto_upload_hint': 'Upload immediately after selection',
                        'docs.uploaded_files': 'Uploaded Files:',
                        'docs.pending_files': 'Pending Documents:',
                        'docs.significance_placeholder': 'Optional: Tell the AI why this file is significant...',
                        'docs.comment_label': 'Comment:',
                        'docs.no_comment': 'No comment added',
                        'docs.edit_comment': 'Edit',
                        'docs.save': 'Save',
                        'docs.cancel': 'Cancel',
                        'docs.comment_saved': 'Comment saved',
                        'docs.comment_save_failed': 'Comment update failed',
                        'docs.parsed': 'Parsed',
                        'button.back': 'Back',
                        'button.continue': 'Continue',
                        'button.upload_continue': 'Upload & Continue',
                        'run.ready_title': 'Ready to Run Assessment',
                        'run.assessment_id': 'Assessment ID:',
                        'run.project': 'Project:',
                        'run.documents': 'Documents:',
                        'run.files_uploaded': 'files uploaded',
                        'run.warning': 'The assessment will analyze your documents against all 17 ITSG-33 control families. This may take several minutes.',
                        'button.run_assessment': 'Run Assessment',
                        'button.running': 'Running...',
                        'assessments.title': 'All Assessments',
                        'assessments.refresh': 'Refresh',
                        'assessments.empty': 'No assessments found.',
                        'assessments.show_deleted': 'Show deleted',
                        'assessments.deleted': 'Deleted',
                        'controls.title': 'ITSG-33 Control Families',
                        'controls.controls_suffix': 'Controls',
                        'controls.profiles_title': 'Security Profiles',
                        'controls.profile_label': 'Profile',
                        'history.title': 'Assessment Run History',
                        'history.total_runs': 'Total Runs:',
                        'history.current_run': 'Current Run',
                        'history.run_label': 'Run',
                        'history.current_badge': 'Current',
                        'history.previous_runs': 'Previous Runs',
                        'history.archived': 'Archived',
                        'history.completed': 'Completed:',
                        'history.documents': 'Documents:',
                        'history.controls_summary': 'Controls Summary',
                        'history.total_assessed': 'Total Assessed:',
                        'history.full_evidence': 'Full Evidence:',
                        'history.partial': 'Partial:',
                        'history.missing': 'Missing:',
                        'history.coverage': 'Coverage:',
                        'history.none': 'No previous runs. This is the first assessment run.',
                        'add_docs.title': 'Add Documents to Assessment',
                        'add_docs.adding_documents': 'Adding documents to:',
                        'add_docs.drag_drop': 'Drag & drop files here or',
                        'add_docs.browse': 'Browse Files',
                        'add_docs.supported': 'Supported: PDF, DOCX, TXT, MD, LOG, PNG, JPG, MP4, MOV, ZIP, TAR.GZ',
                        'add_docs.uploaded_files': 'Uploaded Files',
                        'add_docs.cancel': 'Cancel',
                        'add_docs.add_rerun': 'Add & Rerun Assessment',
                        'reject.not_applicable_title': 'Mark Not Applicable',
                        'reject.reject_evidence_title': 'Reject Evidence',
                        'reject.control_id': 'Control ID:',
                        'reject.control_name': 'Control Name:',
                        'reject.context_not_applicable': 'This control will be marked as not applicable to this solution and excluded from coverage calculations.',
                        'reject.context_reject': 'The evidence will be rejected as insufficient. The control remains applicable and will need better documentation.',
                        'reject.reason': 'Reason',
                        'reject.placeholder_not_applicable': 'e.g., This is a cloud-hosted solution with no on-premise infrastructure...',
                        'reject.placeholder_reject': 'e.g., The document references policies but does not provide implementation details...',
                        'reject.cancel': 'Cancel',
                        'reject.mark_not_applicable': 'Mark Not Applicable',
                        'reject.reject_evidence': 'Reject Evidence',
                        'footer.text': 'ITSG-33 Accreditation System ‚Ä¢ Government of Canada IT Security Standard',
                        'report.assessment_report': 'Assessment Report',
                        'report.download_markdown': 'Download Markdown',
                        'report.download_word': 'Download Word Document',
                        'report.download_poam': 'Download POA&M',
                        'report.report_lang': 'Report Language',
                        'report.title': 'ITSG-33 Security Assessment Report',
                        'report.executive_summary': 'Executive Summary',
                        'report.assessment_id': 'Assessment ID',
                        'report.field': 'Field',
                        'report.value': 'Value',
                        'report.metric': 'Metric',
                        'report.project_name': 'Project Name',
                        'report.client': 'Client',
                        'report.status': 'Status',
                        'report.report_date': 'Report Date',
                        'report.documents_reviewed': 'Documents Reviewed',
                        'report.unknown_project': 'Unknown Project',
                        'report.unknown_client': 'Unknown Client',
                        'report.assessment_status': 'Assessment Status',
                        'report.created_message': 'This assessment has been created but not yet executed. Upload documents and run the assessment to generate results.',
                        'report.next_steps': 'Next Steps',
                        'report.next_steps_upload': 'Upload relevant security documentation (policies, procedures, configurations)',
                        'report.next_steps_diagrams': 'Include architecture diagrams and network documentation',
                        'report.next_steps_run': 'Run the assessment to analyze documents against ITSG-33 controls',
                        'report.in_progress_title': 'Assessment In Progress',
                        'report.in_progress_message': 'The assessment is currently running. Please check back shortly for results.',
                        'report.in_progress_note': 'The system is analyzing your documents against all 17 ITSG-33 control families.',
                        'report.about_title': 'About ITSG-33',
                        'report.about_intro': 'ITSG-33 (IT Security Risk Management: A Lifecycle Approach) is the Government of Canada\'s framework for managing IT security risks. It defines security controls across 17 families:',
                        'report.summary_title': 'Assessment Summary',
                        'report.summary_full': 'Full Evidence',
                        'report.summary_partial': 'Partial Evidence',
                        'report.summary_missing': 'Needs Evidence',
                        'report.summary_not_applicable': 'Not Applicable',
                        'report.summary_coverage': 'Coverage',
                        'report.summary_quality': 'Evidence Quality',
                        'report.summary_applicable': 'Applicable',
                        'report.security_profile': 'Security Profile',
                        'report.attribute': 'Attribute',
                        'report.total_controls_required': 'Total Controls Required',
                        'report.system_analysis': 'System Analysis',
                        'report.system_type': 'System Type',
                        'report.data_classification': 'Data Classification',
                        'report.confidentiality': 'Confidentiality',
                        'report.integrity': 'Integrity',
                        'report.availability': 'Availability',
                        'report.recommended_profile': 'Recommended Profile',
                        'report.rationale': 'Rationale',
                        'report.required_controls_family': 'Required Controls by Family',
                        'report.document_analysis': 'Document Analysis',
                        'report.documents_analyzed': 'document(s) analyzed for security evidence:',
                        'report.document_type': 'Document Type',
                        'report.document_purpose': 'Purpose',
                        'report.controls_addressed': 'Controls Addressed',
                        'report.family': 'Family',
                        'report.controls': 'Controls',
                        'report.control_id': 'Control ID',
                        'report.security_topics': 'Security Topics',
                        'report.none_identified': 'None identified',
                        'report.controls_addressed_title': 'Controls Addressed:',
                        'report.control': 'Control',
                        'report.coverage': 'Coverage',
                        'report.coverage_full': 'FULL',
                        'report.coverage_partial': 'PARTIAL',
                        'report.coverage_none': 'NONE',
                        'report.evidence': 'Evidence',
                        'report.suggested_evidence': 'Suggested Evidence',
                        'report.unknown': 'Unknown',
                        'report.unknown_document': 'Unknown Document',
                        'report.controls_full': 'Controls with Full Evidence',
                        'report.controls_partial': 'Controls with Partial Evidence',
                        'report.controls_missing': 'Controls Missing Evidence',
                        'report.controls_missing_note': 'require evidence documentation:',
                        'report.details_expand': 'Click to expand full list',
                        'report.details_toggle': 'Click to expand/collapse',
                        'report.details_show_all': 'Click to show all',
                        'report.low_priority_controls': 'low-priority controls',
                        'report.actions': 'Actions',
                        'report.no_evidence_details': 'No evidence details',
                        'report.mark_not_applicable': 'Mark as Not Applicable',
                        'report.reject_evidence': 'Reject Evidence',
                        'report.partial_note': 'These controls have some evidence but need additional documentation:',
                        'report.missing_note': 'controls require evidence documentation:',
                        'report.not_applicable_controls': 'Not Applicable Controls',
                        'report.not_applicable_note': 'These controls do not apply to this solution (excluded from coverage):',
                        'report.auto_determined': 'Auto-Determined',
                        'report.auto_reason': 'Determined by system analysis based on technology/architecture:',
                        'report.manual_marked': 'Manually Marked',
                        'report.manual_reason': 'Marked by operator as not applicable:',
                        'report.reason': 'Reason',
                        'report.action': 'Action',
                        'report.restore': 'Restore',
                        'report.restore_tooltip': 'Restore to applicable',
                        'report.auto_label': 'Auto',
                        'report.manual_label': 'Manual',
                        'report.no_reason': 'No reason provided',
                        'report.no_rationale': 'No rationale provided.',
                        'report.rejected_evidence': 'Rejected Evidence',
                        'report.rejected_note': 'These controls are applicable but need better evidence:',
                        'report.had': 'Had',
                        'report.rejection_reason': 'Rejection Reason',
                        'report.restore_evidence': 'Restore evidence',
                        'report.recommendations': 'Recommendations',
                        'report.address_first': 'Address these controls first:',
                        'report.high_priority': 'High Priority',
                        'report.medium_priority': 'Medium Priority',
                        'report.low_priority': 'Low Priority',
                        'report.low_priority_note': 'These controls should be addressed as part of continuous improvement:',
                        'report.provide_documentation': 'Provide required documentation',
                        'report.additional_low_priority': 'additional low-priority controls need attention.',
                        'report.missing_by_family': 'Missing Controls by Family',
                        'report.missing_controls': 'Missing Controls',
                        'report.assessment_error': 'Assessment Error',
                        'report.machine_verifiable': 'Machine-Verifiable',
                        'report.human_curated': 'Human-Curated',
                        'markdown.generated': '*Generated by ITSG-33 Accreditation System*',
                        'toast.assessment_created': 'Assessment created successfully!',
                        'toast.assessment_create_failed': 'Failed to create assessment',
                        'toast.assessment_started': 'Assessment started! This may take a few minutes.',
                        'toast.assessment_run_failed': 'Failed to run assessment',
                        'toast.assessment_load_failed': 'Failed to load assessment details',
                        'toast.assessment_delete_failed': 'Failed to delete assessment',
                        'toast.assessment_restore_failed': 'Failed to restore assessment',
                        'toast.assessment_purge_failed': 'Failed to purge assessment',
                        'toast.markdown_downloaded': 'Markdown report downloaded!',
                        'toast.word_downloaded': 'Word document downloaded!',
                        'toast.word_download_failed': 'Failed to download Word document',
                        'toast.poam_downloaded': 'POA&M document downloaded!',
                        'toast.poam_download_failed': 'Failed to download POA&M',
                        'toast.rerun_confirm': 'This will rerun the assessment with all current documents. Previous results will be saved to history. Continue?',
                        'toast.rerun_started': 'Assessment rerun started. Previous runs:',
                        'toast.rerun_failed': 'Failed to rerun assessment',
                        'toast.history_failed': 'Failed to load history',
                        'toast.upload_success': 'file(s) uploaded',
                        'toast.upload_failed': 'Failed to upload files',
                        'toast.reject_reason_required': 'Please provide a reason',
                        'toast.reject_success_na': 'Control marked as not applicable',
                        'toast.reject_success_reject': 'Evidence rejected',
                        'toast.reject_failed': 'Failed:',
                        'toast.restore_success': 'evidence restored. New coverage:',
                        'toast.restore_failed': 'Failed to restore evidence:',
                        'strength.system_generated': 'System-Generated',
                        'strength.iac': 'IaC',
                        'strength.automated_test': 'Automated Test',
                        'strength.code': 'Code',
                        'strength.screenshot': 'Screenshot',
                        'strength.video': 'Video',
                        'strength.narrative': 'Narrative'
                    },
                    fr: {
                        'app.title': 'Syst√®me d\'accr√©ditation ITSG-33',
                        'app.name': 'Accr√©ditation ITSG-33',
                        'app.subtitle': 'Plateforme d\'√©valuation de la s√©curit√©',
                        'app.system_operational': 'Syst√®me op√©rationnel',
                        'nav.dashboard': 'Tableau de bord',
                        'nav.new_assessment': 'Nouvelle √©valuation',
                        'nav.assessments': '√âvaluations',
                        'nav.controls': 'Familles de mesures de s√©curit√©',
                        'stats.total_assessments': 'Total des √©valuations',
                        'stats.completed': 'Termin√©es',
                        'stats.in_progress': 'En cours',
                        'stats.control_families': 'Familles de mesures',
                        'dashboard.recent_assessments': '√âvaluations r√©centes',
                        'dashboard.empty_assessments': 'Aucune √©valuation pour l\'instant. Cr√©ez votre premi√®re √©valuation pour commencer.',
                        'dashboard.create_assessment': 'Cr√©er une √©valuation',
                        'table.project': 'Projet',
                        'table.client': 'Client',
                        'table.status': 'Statut',
                        'table.created': 'Cr√©√© le',
                        'table.actions': 'Actions',
                        'action.view': 'Voir',
                        'action.run': 'Lancer',
                        'action.add_docs': 'Ajouter des documents',
                        'action.rerun': 'Relancer',
                        'action.history': 'Historique',
                        'action.delete': 'Supprimer',
                        'action.restore': 'Restaurer',
                        'action.purge': 'Purger',
                        'confirm.delete': 'Supprimer cette √©valuation (suppression r√©versible sous 30 jours) ? Vous pourrez la restaurer.',
                        'confirm.purge': 'Supprimer d√©finitivement cette √©valuation et tous les fichiers ? Cette action est irr√©versible.',
                        'toast.assessment_deleted': '√âvaluation supprim√©e',
                        'toast.assessment_restored': '√âvaluation restaur√©e',
                        'toast.assessment_purged': '√âvaluation supprim√©e d√©finitivement',
                        'assessment.new_title': 'Cr√©er une nouvelle √©valuation',
                        'step.details': 'D√©tails',
                        'step.documents': 'Documents',
                        'step.run': 'Ex√©cuter',
                        'form.client_id': 'ID client *',
                        'form.project_name': 'Nom du projet *',
                        'form.conops': 'Concept d\'op√©rations (CONOPS)',
                        'form.client_placeholder': 'p. ex., DEPT_001',
                        'form.project_placeholder': 'p. ex., Projet de migration infonuagique',
                        'form.conops_placeholder': 'D√©crivez la mission du syst√®me, les types de donn√©es trait√©es, la base d\'utilisateurs et le contexte op√©rationnel...',
                        'button.continue_documents': 'Continuer vers les documents',
                        'docs.info': 'T√©l√©versez la documentation de s√©curit√©, notamment les politiques, proc√©dures, diagrammes d\'architecture et preuves de configuration.',
                        'docs.drag_drop': 'Glissez-d√©posez des fichiers ici, ou',
                        'docs.browse': 'parcourir',
                        'docs.supports': 'Formats pris en charge : PDF, DOCX, TXT, MD, LOG, PNG, JPG, MP4, MOV, ZIP, TAR.GZ',
                        'docs.auto_upload': 'T√©l√©versement automatique',
                        'docs.auto_upload_hint': 'T√©l√©verser imm√©diatement apr√®s la s√©lection',
                        'docs.uploaded_files': 'Fichiers t√©l√©vers√©s :',
                        'docs.pending_files': 'Documents en attente :',
                        'docs.significance_placeholder': 'Facultatif : Dites √† l\'IA pourquoi ce fichier est important...',
                        'docs.comment_label': 'Commentaire :',
                        'docs.no_comment': 'Aucun commentaire ajout√©',
                        'docs.edit_comment': 'Modifier',
                        'docs.save': 'Enregistrer',
                        'docs.cancel': 'Annuler',
                        'docs.comment_saved': 'Commentaire enregistr√©',
                        'docs.comment_save_failed': '√âchec de mise √† jour du commentaire',
                        'docs.parsed': 'Analys√©',
                        'button.back': 'Retour',
                        'button.continue': 'Continuer',
                        'button.upload_continue': 'T√©l√©verser et continuer',
                        'run.ready_title': 'Pr√™t √† lancer l\'√©valuation',
                        'run.assessment_id': 'ID de l\'√©valuation :',
                        'run.project': 'Projet :',
                        'run.documents': 'Documents :',
                        'run.files_uploaded': 'fichiers t√©l√©vers√©s',
                        'run.warning': 'L\'√©valuation analysera vos documents par rapport aux 17 familles de mesures ITSG-33. Cela peut prendre plusieurs minutes.',
                        'button.run_assessment': 'Lancer l\'√©valuation',
                        'button.running': 'En cours...',
                        'assessments.title': 'Toutes les √©valuations',
                        'assessments.refresh': 'Actualiser',
                        'assessments.empty': 'Aucune √©valuation trouv√©e.',
                        'assessments.show_deleted': 'Afficher les supprim√©es',
                        'assessments.deleted': 'Supprim√©e',
                        'controls.title': 'Familles de mesures de s√©curit√© ITSG-33',
                        'controls.controls_suffix': 'mesures',
                        'controls.profiles_title': 'Profils de s√©curit√©',
                        'controls.profile_label': 'Profil',
                        'history.title': 'Historique des ex√©cutions d\'√©valuation',
                        'history.total_runs': 'Nombre total d\'ex√©cutions :',
                        'history.current_run': 'Ex√©cution en cours',
                        'history.run_label': 'Ex√©cution',
                        'history.current_badge': 'En cours',
                        'history.previous_runs': 'Ex√©cutions pr√©c√©dentes',
                        'history.archived': 'Archiv√©e',
                        'history.completed': 'Termin√© le :',
                        'history.documents': 'Documents :',
                        'history.controls_summary': 'R√©sum√© des mesures',
                        'history.total_assessed': 'Total √©valu√© :',
                        'history.full_evidence': 'Preuve compl√®te :',
                        'history.partial': 'Partielle :',
                        'history.missing': 'Manquantes :',
                        'history.coverage': 'Couverture :',
                        'history.none': 'Aucune ex√©cution pr√©c√©dente. Il s\'agit de la premi√®re ex√©cution.',
                        'add_docs.title': 'Ajouter des documents √† l\'√©valuation',
                        'add_docs.adding_documents': 'Ajout de documents √† :',
                        'add_docs.drag_drop': 'Glissez-d√©posez des fichiers ici ou',
                        'add_docs.browse': 'Parcourir les fichiers',
                        'add_docs.supported': 'Formats pris en charge : PDF, DOCX, TXT, MD, LOG, PNG, JPG, MP4, MOV, ZIP, TAR.GZ',
                        'add_docs.uploaded_files': 'Fichiers t√©l√©vers√©s',
                        'add_docs.cancel': 'Annuler',
                        'add_docs.add_rerun': 'Ajouter et relancer l\'√©valuation',
                        'reject.not_applicable_title': 'Marquer comme sans objet',
                        'reject.reject_evidence_title': 'Rejeter la preuve',
                        'reject.control_id': 'ID de la mesure :',
                        'reject.control_name': 'Nom de la mesure :',
                        'reject.context_not_applicable': 'Cette mesure sera marqu√©e comme sans objet pour cette solution et exclue des calculs de couverture.',
                        'reject.context_reject': 'La preuve sera rejet√©e comme insuffisante. La mesure demeure applicable et n√©cessitera une meilleure documentation.',
                        'reject.reason': 'Justification',
                        'reject.placeholder_not_applicable': 'p. ex., Cette solution est h√©berg√©e dans le nuage et n\'a aucune infrastructure sur site...',
                        'reject.placeholder_reject': 'p. ex., Le document mentionne des politiques mais ne fournit pas de d√©tails de mise en ≈ìuvre...',
                        'reject.cancel': 'Annuler',
                        'reject.mark_not_applicable': 'Marquer comme sans objet',
                        'reject.reject_evidence': 'Rejeter la preuve',
                        'footer.text': 'Syst√®me d\'accr√©ditation ITSG-33 ‚Ä¢ Norme de s√©curit√© informatique du gouvernement du Canada',
                        'report.assessment_report': 'Rapport d\'√©valuation',
                        'report.download_markdown': 'T√©l√©charger le Markdown',
                        'report.download_word': 'T√©l√©charger le document Word',
                        'report.download_poam': 'T√©l√©charger le POA&M',
                        'report.report_lang': 'Langue du rapport',
                        'report.title': 'Rapport d\'√©valuation de la s√©curit√© ITSG-33',
                        'report.executive_summary': 'R√©sum√© de direction',
                        'report.assessment_id': 'ID de l\'√©valuation',
                        'report.field': 'Champ',
                        'report.value': 'Valeur',
                        'report.metric': 'Indicateur',
                        'report.project_name': 'Nom du projet',
                        'report.client': 'Client',
                        'report.status': 'Statut',
                        'report.report_date': 'Date du rapport',
                        'report.documents_reviewed': 'Documents examin√©s',
                        'report.unknown_project': 'Projet inconnu',
                        'report.unknown_client': 'Client inconnu',
                        'report.assessment_status': 'Statut de l\'√©valuation',
                        'report.created_message': 'Cette √©valuation a √©t√© cr√©√©e mais n\'a pas encore √©t√© ex√©cut√©e. T√©l√©versez des documents et lancez l\'√©valuation pour g√©n√©rer des r√©sultats.',
                        'report.next_steps': 'Prochaines √©tapes',
                        'report.next_steps_upload': 'T√©l√©verser la documentation de s√©curit√© pertinente (politiques, proc√©dures, configurations)',
                        'report.next_steps_diagrams': 'Inclure les diagrammes d\'architecture et la documentation r√©seau',
                        'report.next_steps_run': 'Lancer l\'√©valuation pour analyser les documents par rapport aux mesures ITSG-33',
                        'report.in_progress_title': '√âvaluation en cours',
                        'report.in_progress_message': 'L\'√©valuation est en cours. Veuillez revenir bient√¥t pour les r√©sultats.',
                        'report.in_progress_note': 'Le syst√®me analyse vos documents par rapport aux 17 familles de mesures ITSG-33.',
                        'report.about_title': '√Ä propos d\'ITSG-33',
                        'report.about_intro': 'ITSG-33 (Gestion des risques li√©s √† la s√©curit√© des TI : une approche fond√©e sur le cycle de vie) est le cadre du gouvernement du Canada pour la gestion des risques de s√©curit√© des TI. Il d√©finit des mesures de s√©curit√© r√©parties en 17 familles :',
                        'report.summary_title': 'R√©sum√© de l\'√©valuation',
                        'report.summary_full': 'Preuve compl√®te',
                        'report.summary_partial': 'Preuve partielle',
                        'report.summary_missing': 'Preuves manquantes',
                        'report.summary_not_applicable': 'Sans objet',
                        'report.summary_coverage': 'Couverture',
                        'report.summary_quality': 'Qualit√© des preuves',
                        'report.summary_applicable': 'Applicables',
                        'report.security_profile': 'Profil de s√©curit√©',
                        'report.attribute': 'Attribut',
                        'report.total_controls_required': 'Total des mesures requises',
                        'report.system_analysis': 'Analyse du syst√®me',
                        'report.system_type': 'Type de syst√®me',
                        'report.data_classification': 'Classification des donn√©es',
                        'report.confidentiality': 'Confidentialit√©',
                        'report.integrity': 'Int√©grit√©',
                        'report.availability': 'Disponibilit√©',
                        'report.recommended_profile': 'Profil recommand√©',
                        'report.rationale': 'Justification',
                        'report.required_controls_family': 'Mesures requises par famille',
                        'report.document_analysis': 'Analyse des documents',
                        'report.documents_analyzed': 'document(s) analys√©(s) pour les preuves de s√©curit√© :',
                        'report.document_type': 'Type de document',
                        'report.document_purpose': 'Objectif',
                        'report.controls_addressed': 'Mesures couvertes',
                        'report.family': 'Famille',
                        'report.controls': 'Mesures',
                        'report.control_id': 'ID de la mesure',
                        'report.security_topics': 'Sujets de s√©curit√©',
                        'report.none_identified': 'Aucun √©l√©ment identifi√©',
                        'report.controls_addressed_title': 'Mesures couvertes :',
                        'report.control': 'Mesure',
                        'report.coverage': 'Couverture',
                        'report.coverage_full': 'COMPL√àTE',
                        'report.coverage_partial': 'PARTIELLE',
                        'report.coverage_none': 'AUCUNE',
                        'report.evidence': 'Preuve',
                        'report.suggested_evidence': 'Preuve sugg√©r√©e',
                        'report.unknown': 'Inconnu',
                        'report.unknown_document': 'Document inconnu',
                        'report.controls_full': 'Mesures avec preuve compl√®te',
                        'report.controls_partial': 'Mesures avec preuve partielle',
                        'report.controls_missing': 'Mesures sans preuve',
                        'report.controls_missing_note': 'n√©cessitent une preuve :',
                        'report.details_expand': 'Cliquer pour afficher la liste compl√®te',
                        'report.details_toggle': 'Cliquer pour d√©velopper/r√©duire',
                        'report.details_show_all': 'Cliquer pour afficher les',
                        'report.low_priority_controls': 'mesures de priorit√© faible',
                        'report.actions': 'Actions',
                        'report.no_evidence_details': 'Aucun d√©tail de preuve',
                        'report.mark_not_applicable': 'Marquer comme sans objet',
                        'report.reject_evidence': 'Rejeter la preuve',
                        'report.partial_note': 'Ces mesures ont des preuves partielles mais n√©cessitent une documentation suppl√©mentaire :',
                        'report.missing_note': 'mesures n√©cessitent une preuve :',
                        'report.not_applicable_controls': 'Mesures sans objet',
                        'report.not_applicable_note': 'Ces mesures ne s\'appliquent pas √† cette solution (exclues de la couverture) :',
                        'report.auto_determined': 'D√©termin√©es automatiquement',
                        'report.auto_reason': 'D√©termin√©es par l\'analyse du syst√®me selon la technologie/l\'architecture :',
                        'report.manual_marked': 'Marqu√©es manuellement',
                        'report.manual_reason': 'Marqu√©es par l\'op√©rateur comme sans objet :',
                        'report.reason': 'Justification',
                        'report.action': 'Action',
                        'report.restore': 'Restaurer',
                        'report.restore_tooltip': 'R√©activer comme applicable',
                        'report.auto_label': 'Auto',
                        'report.manual_label': 'Manuel',
                        'report.no_reason': 'Aucune justification fournie',
                        'report.no_rationale': 'Aucune justification fournie.',
                        'report.rejected_evidence': 'Preuve rejet√©e',
                        'report.rejected_note': 'Ces mesures sont applicables mais n√©cessitent de meilleures preuves :',
                        'report.had': 'Avait',
                        'report.rejection_reason': 'Motif du rejet',
                        'report.restore_evidence': 'Restaurer la preuve',
                        'report.recommendations': 'Recommandations',
                        'report.address_first': 'Traiter ces mesures en priorit√© :',
                        'report.high_priority': 'Priorit√© √©lev√©e',
                        'report.medium_priority': 'Priorit√© moyenne',
                        'report.low_priority': 'Priorit√© faible',
                        'report.low_priority_note': 'Ces mesures doivent √™tre trait√©es dans le cadre de l\'am√©lioration continue :',
                        'report.provide_documentation': 'Fournir la documentation requise',
                        'report.additional_low_priority': 'autres mesures de priorit√© faible requi√®rent une attention.',
                        'report.missing_by_family': 'Mesures manquantes par famille',
                        'report.missing_controls': 'Mesures manquantes',
                        'report.assessment_error': 'Erreur d\'√©valuation',
                        'report.machine_verifiable': 'V√©rifiable par machine',
                        'report.human_curated': 'Valid√© par un humain',
                        'markdown.generated': '*G√©n√©r√© par le syst√®me d\'accr√©ditation ITSG-33*',
                        'toast.assessment_created': '√âvaluation cr√©√©e avec succ√®s !',
                        'toast.assessment_create_failed': '√âchec de la cr√©ation de l\'√©valuation',
                        'toast.assessment_started': '√âvaluation lanc√©e ! Cela peut prendre plusieurs minutes.',
                        'toast.assessment_run_failed': '√âchec du lancement de l\'√©valuation',
                        'toast.assessment_load_failed': 'Impossible de charger les d√©tails de l\'√©valuation',
                        'toast.assessment_delete_failed': '√âchec de la suppression de l\'√©valuation',
                        'toast.assessment_restore_failed': '√âchec de la restauration de l\'√©valuation',
                        'toast.assessment_purge_failed': '√âchec de la purge de l\'√©valuation',
                        'toast.markdown_downloaded': 'Rapport Markdown t√©l√©charg√© !',
                        'toast.word_downloaded': 'Document Word t√©l√©charg√© !',
                        'toast.word_download_failed': '√âchec du t√©l√©chargement du document Word',
                        'toast.poam_downloaded': 'Document POA&M t√©l√©charg√© !',
                        'toast.poam_download_failed': '√âchec du t√©l√©chargement du POA&M',
                        'toast.rerun_confirm': 'Cette action relancera l\'√©valuation avec tous les documents actuels. Les r√©sultats pr√©c√©dents seront enregistr√©s dans l\'historique. Continuer ?',
                        'toast.rerun_started': 'Relance de l\'√©valuation d√©marr√©e. Ex√©cutions pr√©c√©dentes :',
                        'toast.rerun_failed': '√âchec de la relance de l\'√©valuation',
                        'toast.history_failed': '√âchec du chargement de l\'historique',
                        'toast.upload_success': 'fichier(s) t√©l√©vers√©(s)',
                        'toast.upload_failed': '√âchec du t√©l√©versement des fichiers',
                        'toast.reject_reason_required': 'Veuillez fournir une justification',
                        'toast.reject_success_na': 'Mesure marqu√©e comme sans objet',
                        'toast.reject_success_reject': 'Preuve rejet√©e',
                        'toast.reject_failed': '√âchec :',
                        'toast.restore_success': 'preuve restaur√©e. Nouvelle couverture :',
                        'toast.restore_failed': '√âchec de la restauration de la preuve :',
                        'strength.system_generated': 'G√©n√©r√© par le syst√®me',
                        'strength.iac': 'IaC',
                        'strength.automated_test': 'Test automatis√©',
                        'strength.code': 'Code',
                        'strength.screenshot': 'Capture d\'√©cran',
                        'strength.video': 'Vid√©o',
                        'strength.narrative': 'Narratif'
                    }
                },
                currentTab: 'dashboard',
                step: 1,
                assessments: [],
                controlFamilies: [],
                profiles: [],
                newAssessment: {
                    client_id: '',
                    project_name: '',
                    conops: ''
                },
                currentAssessmentId: null,
                reportLang: 'en',
                autoUpload: false,
                showDeleted: false,
                uploadedFiles: [],
                pendingFiles: [],
                editingFileId: null,
                editingNote: '',
                selectedAssessment: null,
                assessmentResults: null,
                showModal: false,
                showHistoryModal: false,
                showAddDocsModal: false,
                assessmentHistory: null,
                addDocsAssessment: null,
                addDocsFiles: [],
                isRunning: false,
                dragover: false,
                toast: { show: false, message: '', type: 'info' },
                showRejectModal: false,
                rejectingControl: null,
                rejectAction: 'reject_evidence',  // 'reject_evidence' or 'not_applicable'
                rejectReason: '',
                rejectError: '',

                async init() {
                    const savedLang = localStorage.getItem('itsg33-lang');
                    if (savedLang === 'en' || savedLang === 'fr') {
                        this.lang = savedLang;
                    }
                    const savedAutoUpload = localStorage.getItem('itsg33-auto-upload');
                    if (savedAutoUpload === 'true') {
                        this.autoUpload = true;
                    }
                    const savedShowDeleted = localStorage.getItem('itsg33-show-deleted');
                    if (savedShowDeleted === 'true') {
                        this.showDeleted = true;
                    }
                    this.updateLanguage();
                    this.$watch('lang', (value) => {
                        localStorage.setItem('itsg33-lang', value);
                        this.updateLanguage();
                        this.loadControlFamilies();
                        this.loadProfiles();
                    });
                    this.$watch('autoUpload', (value) => {
                        localStorage.setItem('itsg33-auto-upload', value ? 'true' : 'false');
                    });
                    this.$watch('showDeleted', (value) => {
                        localStorage.setItem('itsg33-show-deleted', value ? 'true' : 'false');
                        this.loadAssessments();
                    });

                    await this.loadAssessments();
                    await this.loadControlFamilies();
                    await this.loadProfiles();

                    // Listen for reject-evidence events
                    window.addEventListener('reject-evidence', (e) => {
                        this.openRejectModal(e.detail, 'reject_evidence');
                    });

                    // Listen for mark-not-applicable events
                    window.addEventListener('mark-not-applicable', (e) => {
                        this.openRejectModal(e.detail, 'not_applicable');
                    });

                    // Listen for restore-control events
                    window.addEventListener('restore-control', (e) => {
                        this.restoreEvidence(e.detail);
                    });
                },

                async loadAssessments() {
                    try {
                        const response = await fetch(`/api/v1/assessments?include_deleted=${this.showDeleted ? 'true' : 'false'}`);
                        const data = await response.json();
                        this.assessments = data.assessments || [];
                    } catch (error) {
                        console.error('Failed to load assessments:', error);
                    }
                },

                async deleteAssessment(assessmentId) {
                    const confirmed = confirm(this.t('confirm.delete'));
                    if (!confirmed) return;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Delete failed');
                        this.showToast(this.t('toast.assessment_deleted'), 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_delete_failed') || 'Delete failed', 'error');
                    }
                },

                async restoreAssessment(assessmentId) {
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/restore`, {
                            method: 'POST'
                        });
                        if (!response.ok) throw new Error('Restore failed');
                        this.showToast(this.t('toast.assessment_restored'), 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_restore_failed') || 'Restore failed', 'error');
                    }
                },

                async purgeAssessment(assessmentId) {
                    const confirmed = confirm(this.t('confirm.purge'));
                    if (!confirmed) return;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/purge`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Purge failed');
                        this.showToast(this.t('toast.assessment_purged'), 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_purge_failed') || 'Purge failed', 'error');
                    }
                },

                async loadControlFamilies() {
                    try {
                        const response = await fetch(`/api/v1/controls/families?lang=${this.lang}`);
                        const data = await response.json();
                        this.controlFamilies = data.families || [];
                    } catch (error) {
                        console.error('Failed to load control families:', error);
                    }
                },

                async loadProfiles() {
                    try {
                        const response = await fetch(`/api/v1/profiles?lang=${this.lang}`);
                        const data = await response.json();
                        this.profiles = data.profiles || [];
                    } catch (error) {
                        console.error('Failed to load profiles:', error);
                    }
                },

                setLang(lang) {
                    this.lang = lang;
                    this.reportLang = lang;
                },

                updateLanguage() {
                    document.title = this.t('app.title');
                    document.documentElement.lang = this.lang;
                },

                t(key) {
                    const current = this.i18n[this.lang] || {};
                    return current[key] || this.i18n.en[key] || key;
                },

                getControlFamilyName(code) {
                    const families = {
                        AC: { en: 'Access Control', fr: 'Contr√¥le d\'acc√®s' },
                        AT: { en: 'Awareness and Training', fr: 'Sensibilisation et formation' },
                        AU: { en: 'Audit and Accountability', fr: 'Audit et responsabilit√©' },
                        CA: { en: 'Assessment, Authorization, and Monitoring', fr: '√âvaluation, autorisation et surveillance' },
                        CM: { en: 'Configuration Management', fr: 'Gestion de configuration' },
                        CP: { en: 'Contingency Planning', fr: 'Planification des mesures d\'urgence' },
                        IA: { en: 'Identification and Authentication', fr: 'Identification et authentification' },
                        IR: { en: 'Incident Response', fr: 'Intervention en cas d\'incident' },
                        MA: { en: 'Maintenance', fr: 'Maintenance' },
                        MP: { en: 'Media Protection', fr: 'Protection des supports' },
                        PE: { en: 'Physical and Environmental Protection', fr: 'Protection physique et environnementale' },
                        PL: { en: 'Planning', fr: 'Planification' },
                        PS: { en: 'Personnel Security', fr: 'S√©curit√© du personnel' },
                        RA: { en: 'Risk Assessment', fr: '√âvaluation des risques' },
                        SA: { en: 'System and Services Acquisition', fr: 'Acquisition de syst√®mes et de services' },
                        SC: { en: 'System and Communications Protection', fr: 'Protection des syst√®mes et des communications' },
                        SI: { en: 'System and Information Integrity', fr: 'Int√©grit√© des syst√®mes et de l\'information' }
                    };
                    return families[code]?.[this.lang] || families[code]?.en || code;
                },

                getControlFamilyLabel(code) {
                    if (this.lang === 'fr') {
                        return `${this.t('controls.controls_suffix')} ${code}`;
                    }
                    return `${code} ${this.t('controls.controls_suffix')}`;
                },

                getProfileLabel(number) {
                    const labels = {
                        1: { en: 'Low Impact', fr: 'Impact faible' },
                        2: { en: 'Moderate Impact', fr: 'Impact mod√©r√©' },
                        3: { en: 'High Impact', fr: 'Impact √©lev√©' }
                    };
                    return labels[number]?.[this.lang] || labels[number]?.en || '';
                },

                getProfileDescription(number) {
                    const descriptions = {
                        1: {
                            en: 'Baseline controls for low-impact systems.',
                            fr: 'Mesures de base pour les syst√®mes √† impact faible.'
                        },
                        2: {
                            en: 'Enhanced controls for moderate-impact systems.',
                            fr: 'Mesures renforc√©es pour les syst√®mes √† impact mod√©r√©.'
                        },
                        3: {
                            en: 'Comprehensive controls for high-impact systems.',
                            fr: 'Mesures compl√®tes pour les syst√®mes √† impact √©lev√©.'
                        }
                    };
                    return descriptions[number]?.[this.lang] || descriptions[number]?.en || '';
                },

                formatProfileTitle(number) {
                    return `${this.t('controls.profile_label')} ${number}`;
                },

                getStatusLabel(status) {
                    const labels = {
                        created: { en: 'created', fr: 'cr√©√©e' },
                        in_progress: { en: 'in progress', fr: 'en cours' },
                        running: { en: 'running', fr: 'en cours' },
                        completed: { en: 'completed', fr: 'termin√©e' },
                        error: { en: 'error', fr: 'erreur' }
                    };
                    return labels[status]?.[this.lang] || labels[status]?.en || status;
                },

                formatDocumentsReviewed(documents, diagrams) {
                    if (this.lang === 'fr') {
                        return `${documents} documents, ${diagrams} diagrammes`;
                    }
                    return `${documents} documents, ${diagrams} diagrams`;
                },

                formatUploadMessage(count) {
                    return `${count} ${this.t('toast.upload_success')}`;
                },

                getCoverageLabel(coverage) {
                    if (coverage === 'FULL') {
                        return this.t('report.coverage_full');
                    }
                    if (coverage === 'PARTIAL') {
                        return this.t('report.coverage_partial');
                    }
                    if (coverage === 'NONE') {
                        return this.t('report.coverage_none');
                    }
                    return coverage || this.t('report.unknown');
                },

                async createAssessment() {
                    try {
                        const response = await fetch('/api/v1/assessment/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newAssessment)
                        });
                        const data = await response.json();
                        this.currentAssessmentId = data.assessment_id;
                        this.step = 2;
                        this.showToast(this.t('toast.assessment_created'), 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_create_failed'), 'error');
                    }
                },

                handleFiles(event) {
                    const newFiles = Array.from(event.target.files).map(file => ({
                        file: file,
                        filename: file.name,
                        significance_note: ''
                    }));
                    this.pendingFiles = [...this.pendingFiles, ...newFiles];
                    if (this.autoUpload) {
                        this.uploadPendingFiles();
                    }
                },

                handleDrop(event) {
                    this.dragover = false;
                    const newFiles = Array.from(event.dataTransfer.files).map(file => ({
                        file: file,
                        filename: file.name,
                        significance_note: ''
                    }));
                    this.pendingFiles = [...this.pendingFiles, ...newFiles];
                    if (this.autoUpload) {
                        this.uploadPendingFiles();
                    }
                },

                async uploadPendingFiles() {
                    if (!this.currentAssessmentId || this.pendingFiles.length === 0) return;

                    const formData = new FormData();
                    const metadata = [];

                    for (const pf of this.pendingFiles) {
                        formData.append('files', pf.file);
                        metadata.push({
                            filename: pf.filename,
                            significance_note: pf.significance_note
                        });
                    }

                    formData.append('metadata', JSON.stringify(metadata));

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.currentAssessmentId}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        this.uploadedFiles = [...this.uploadedFiles, ...data.uploaded_files];
                        this.pendingFiles = [];
                        this.showToast(this.formatUploadMessage(data.successful), 'success');
                        this.step = 3;
                    } catch (error) {
                        this.showToast(this.t('toast.upload_failed'), 'error');
                    }
                },

                startEditComment(file) {
                    if (!file.file_id) return;
                    this.editingFileId = file.file_id;
                    this.editingNote = file.significance_note || '';
                },

                cancelEditComment() {
                    this.editingFileId = null;
                    this.editingNote = '';
                },

                async saveEditComment(file) {
                    if (!file.file_id || !this.currentAssessmentId) return;
                    try {
                        const response = await fetch(`/api/v1/assessment/${this.currentAssessmentId}/documents/${file.file_id}/metadata`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ significance_note: this.editingNote })
                        });
                        if (!response.ok) throw new Error('Update failed');
                        file.significance_note = this.editingNote;
                        if (file.user_metadata) {
                            file.user_metadata.significance_note = this.editingNote;
                        }
                        this.cancelEditComment();
                        this.showToast(this.t('docs.comment_saved') || 'Comment saved', 'success');
                    } catch (error) {
                        this.showToast(this.t('docs.comment_save_failed') || 'Comment update failed', 'error');
                    }
                },

                async runAssessment() {
                    if (!this.currentAssessmentId) return;
                    this.isRunning = true;

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.currentAssessmentId}/run`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.showToast(this.t('toast.assessment_started'), 'success');

                        this.step = 1;
                        this.newAssessment = { client_id: '', project_name: '', conops: '' };
                        this.uploadedFiles = [];
                        this.currentAssessmentId = null;
                        this.currentTab = 'assessments';
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_run_failed'), 'error');
                    } finally {
                        this.isRunning = false;
                    }
                },

                async viewAssessment(assessmentId) {
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/status`);
                        this.selectedAssessment = await response.json();

                        if (this.selectedAssessment.status === 'completed') {
                            try {
                                const resultsResponse = await fetch(`/api/v1/assessment/${assessmentId}/results`);
                                if (resultsResponse.ok) {
                                    this.assessmentResults = await resultsResponse.json();
                                }
                            } catch (e) {
                                this.assessmentResults = null;
                            }
                        } else {
                            this.assessmentResults = null;
                        }

                        this.reportLang = this.lang;
                        this.showModal = true;
                    } catch (error) {
                        this.showToast(this.t('toast.assessment_load_failed'), 'error');
                    }
                },

                selectAssessmentForRun(assessment) {
                    this.currentAssessmentId = assessment.assessment_id;
                    this.newAssessment.project_name = assessment.project_name;
                    this.newAssessment.client_id = assessment.client_id;
                    this.step = 2;
                    this.currentTab = 'new';
                },

                renderAssessmentReport() {
                    if (!this.selectedAssessment) return '';

                    const a = this.selectedAssessment;
                    const r = this.assessmentResults;
                    const locale = this.lang === 'fr' ? 'fr-CA' : 'en-CA';
                    const date = new Date().toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });

                    let html = `
                        <h1>${this.t('report.title')}</h1>

                        <h2>${this.t('report.executive_summary')}</h2>
                        <table>
                            <tr><th style="width:200px">${this.t('report.assessment_id')}</th><td><code>${a.assessment_id || 'N/A'}</code></td></tr>
                            <tr><th>${this.t('report.project_name')}</th><td><strong>${this.getProjectName()}</strong></td></tr>
                            <tr><th>${this.t('report.client')}</th><td>${this.getClientId()}</td></tr>
                            <tr><th>${this.t('report.status')}</th><td><span class="${this.getStatusCssClass(a.status)}">${this.getStatusLabel(a.status) || this.t('report.unknown')}</span></td></tr>
                            <tr><th>${this.t('report.report_date')}</th><td>${date}</td></tr>
                            <tr><th>${this.t('report.documents_reviewed')}</th><td>${this.formatDocumentsReviewed(a.document_count || 0, a.diagram_count || 0)}</td></tr>
                        </table>
                    `;

                    if (a.status === 'completed' && r) {
                        html += this.renderCompletedResults(r);
                    } else if (a.status === 'created') {
                        html += `
                            <h2>${this.t('report.assessment_status')}</h2>
                            <p>${this.t('report.created_message')}</p>

                            <h3>${this.t('report.next_steps')}</h3>
                            <ul>
                                <li>${this.t('report.next_steps_upload')}</li>
                                <li>${this.t('report.next_steps_diagrams')}</li>
                                <li>${this.t('report.next_steps_run')}</li>
                            </ul>
                        `;
                    } else if (a.status === 'in_progress' || a.status === 'running') {
                        html += `
                            <h2>${this.t('report.in_progress_title')}</h2>
                            <p>${this.t('report.in_progress_message')}</p>
                            <p>${this.t('report.in_progress_note')}</p>
                        `;
                    }

                    html += `
                        <h2>${this.t('report.about_title')}</h2>
                        <p>${this.t('report.about_intro')}</p>
                        <ul>
                            <li><strong>AC</strong> - ${this.getControlFamilyName('AC')}</li>
                            <li><strong>AT</strong> - ${this.getControlFamilyName('AT')}</li>
                            <li><strong>AU</strong> - ${this.getControlFamilyName('AU')}</li>
                            <li><strong>CA</strong> - ${this.getControlFamilyName('CA')}</li>
                            <li><strong>CM</strong> - ${this.getControlFamilyName('CM')}</li>
                            <li><strong>CP</strong> - ${this.getControlFamilyName('CP')}</li>
                            <li><strong>IA</strong> - ${this.getControlFamilyName('IA')}</li>
                            <li><strong>IR</strong> - ${this.getControlFamilyName('IR')}</li>
                            <li><strong>MA</strong> - ${this.getControlFamilyName('MA')}</li>
                            <li><strong>MP</strong> - ${this.getControlFamilyName('MP')}</li>
                            <li><strong>PE</strong> - ${this.getControlFamilyName('PE')}</li>
                            <li><strong>PL</strong> - ${this.getControlFamilyName('PL')}</li>
                            <li><strong>PS</strong> - ${this.getControlFamilyName('PS')}</li>
                            <li><strong>RA</strong> - ${this.getControlFamilyName('RA')}</li>
                            <li><strong>SA</strong> - ${this.getControlFamilyName('SA')}</li>
                            <li><strong>SC</strong> - ${this.getControlFamilyName('SC')}</li>
                            <li><strong>SI</strong> - ${this.getControlFamilyName('SI')}</li>
                        </ul>
                    `;

                    return html;
                },

                renderCompletedResults(r) {
                    let html = '';

                    // Summary section
                    if (r.summary) {
                        const s = r.summary;
                        const coveragePct = s.coverage_percentage || 0;
                        const coverageColor = coveragePct >= 70 ? '#059669' : coveragePct >= 40 ? '#d97706' : '#dc2626';

                        const notApplicableList = r.phases?.coverage?.not_applicable || [];
                        const rejectedEvidenceList = r.phases?.coverage?.rejected_evidence || [];
                        const notApplicableCount = notApplicableList.length;
                        const autoNACount = notApplicableList.filter(c => c.auto_determined === true).length;
                        const manualNACount = notApplicableList.filter(c => c.auto_determined === false).length;
                        const rejectedEvidenceCount = rejectedEvidenceList.length;
                        html += `
                            <h2>${this.t('report.summary_title')}</h2>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem">
                                <div style="background:#f0fdf4;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#059669">${s.controls_with_evidence || 0}</div>
                                    <div style="font-size:0.875rem;color:#166534">${this.t('report.summary_full')}</div>
                                </div>
                                <div style="background:#fef9c3;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#d97706">${s.controls_partial || 0}</div>
                                    <div style="font-size:0.875rem;color:#92400e">${this.t('report.summary_partial')}</div>
                                </div>
                                <div style="background:#fee2e2;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#dc2626">${(s.controls_missing || 0) + rejectedEvidenceCount}</div>
                                    <div style="font-size:0.875rem;color:#991b1b">${this.t('report.summary_missing')}</div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.5rem">
                                <div style="background:#dbeafe;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#1e40af">${notApplicableCount}</div>
                                    <div style="font-size:0.75rem;color:#3b82f6">${this.t('report.summary_not_applicable')}</div>
                                    <div style="font-size:0.65rem;color:#6b7280;margin-top:2px"><i class="fas fa-robot"></i> ${autoNACount} ${this.t('report.auto_label')} / <i class="fas fa-user"></i> ${manualNACount} ${this.t('report.manual_label')}</div>
                                </div>
                                <div style="background:#fef3c7;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#92400e">${rejectedEvidenceCount}</div>
                                    <div style="font-size:0.75rem;color:#d97706">${this.t('report.rejected_evidence')}</div>
                                </div>
                                <div style="background:#f3f4f6;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:${coverageColor}">${coveragePct}%</div>
                                    <div style="font-size:0.75rem;color:#6b7280">${this.t('report.summary_coverage')}</div>
                                </div>
                                <div style="background:#e0f2fe;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#0369a1">${s.quality_score || 0}%</div>
                                    <div style="font-size:0.75rem;color:#0284c7">${this.t('report.summary_quality')}</div>
                                    <div style="font-size:0.65rem;color:#6b7280;margin-top:2px"><i class="fas fa-robot"></i> ${s.machine_verifiable_count || 0} / <i class="fas fa-user"></i> ${s.human_curated_count || 0}</div>
                                </div>
                                <div style="background:#e0e7ff;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#4338ca">${s.applicable_controls || (s.total_controls - notApplicableCount)}</div>
                                    <div style="font-size:0.75rem;color:#6366f1">${this.t('report.summary_applicable')}</div>
                                </div>
                            </div>
                            <table>
                                <tr><th style="width:200px">${this.t('report.security_profile')}</th><td><strong>${this.formatProfileTitle(s.profile || 2)}</strong> (${this.getProfileLabel(s.profile || 2)})</td></tr>
                                <tr><th>${this.t('report.total_controls_required')}</th><td>${s.total_controls || 0}</td></tr>
                            </table>
                        `;
                    }

                    if (r.phases) {
                        // System Analysis
                        if (r.phases.system_analysis) {
                            const sa = r.phases.system_analysis;
                            html += `
                                <h2>${this.t('report.system_analysis')}</h2>
                                <table>
                                    <tr><th style="width:200px">${this.t('report.system_type')}</th><td>${sa.system_type || this.t('report.unknown')}</td></tr>
                                    <tr><th>${this.t('report.data_classification')}</th><td>${sa.data_classification || this.t('report.unknown')}</td></tr>
                                    <tr><th>${this.t('report.confidentiality')}</th><td>${sa.confidentiality || this.t('report.unknown')}</td></tr>
                                    <tr><th>${this.t('report.integrity')}</th><td>${sa.integrity || this.t('report.unknown')}</td></tr>
                                    <tr><th>${this.t('report.availability')}</th><td>${sa.availability || this.t('report.unknown')}</td></tr>
                                    <tr><th>${this.t('report.recommended_profile')}</th><td><strong>${this.formatProfileTitle(sa.recommended_profile || 2)}</strong></td></tr>
                                </table>
                                <h3>${this.t('report.rationale')}</h3>
                                <p>${sa.rationale || this.t('report.no_rationale')}</p>
                            `;
                        }

                        // Required Controls by Family
                        if (r.phases.required_controls && r.phases.required_controls.controls_by_family) {
                            const cbf = r.phases.required_controls.controls_by_family;
                            html += `
                                <h2>${this.t('report.required_controls_family')}</h2>
                                <table>
                                    <tr><th>${this.t('report.family')}</th><th>${this.t('report.controls')}</th></tr>
                            `;
                            for (const [family, controls] of Object.entries(cbf)) {
                                html += `<tr><td><strong>${this.getControlFamilyName(family)}</strong></td><td>${controls.length} ${this.t('controls.controls_suffix')}</td></tr>`;
                            }
                            html += `</table>`;
                        }

                        // Evidence Analysis - Document Analysis
                        if (r.phases.evidence_analysis && r.phases.evidence_analysis.document_analyses) {
                            const docs = r.phases.evidence_analysis.document_analyses;
                            html += `
                                <h2>${this.t('report.document_analysis')}</h2>
                                <p>${docs.length} ${this.t('report.documents_analyzed')}</p>
                            `;

                            for (const doc of docs) {
                                const controlCount = Object.keys(doc.controls_addressed || {}).length;
                                html += `
                                    <h3>${doc.filename || this.t('report.unknown_document')}</h3>
                                    <table>
                                        <tr><th style="width:200px">${this.t('report.document_type')}</th><td>${doc.document_type || this.t('report.unknown')}</td></tr>
                                        <tr><th>${this.t('report.document_purpose')}</th><td>${doc.document_purpose || this.t('report.unknown')}</td></tr>
                                        <tr><th>${this.t('report.controls_addressed')}</th><td>${controlCount} ${this.t('report.controls')}</td></tr>
                                        <tr><th>${this.t('report.security_topics')}</th><td>${(doc.key_security_topics || []).join(', ') || this.t('report.none_identified')}</td></tr>
                                    </table>
                                `;

                                if (controlCount > 0) {
                                    html += `<h4>${this.t('report.controls_addressed_title')}</h4><table><tr><th>${this.t('report.control')}</th><th>${this.t('report.coverage')}</th><th>${this.t('report.evidence')}</th></tr>`;
                                    for (const [ctrlId, evidence] of Object.entries(doc.controls_addressed)) {
                                        const coverageClass = evidence.coverage === 'FULL' ? 'status-implemented' : evidence.coverage === 'PARTIAL' ? 'status-partial' : 'status-not-implemented';
                                        html += `<tr><td><strong>${ctrlId}</strong></td><td class="${coverageClass}">${this.getCoverageLabel(evidence.coverage)}</td><td>${evidence.evidence_summary || ''}</td></tr>`;
                                    }
                                    html += `</table>`;
                                }
                            }
                        }

                        // Coverage Details
                        if (r.phases.coverage) {
                            const cov = r.phases.coverage;

                            // Controls with full evidence
                            if (cov.full_coverage && cov.full_coverage.length > 0) {
                                html += `
                                    <h2>${this.t('report.controls_full')} (${cov.full_coverage.length})</h2>
                                    <details>
                                        <summary style="cursor:pointer;color:#059669;font-weight:500;margin-bottom:10px;">${this.t('report.details_expand')}</summary>
                                        <table><tr><th style="width:120px">${this.t('report.control')}</th><th>${this.t('report.evidence')}</th><th style="width:140px">${this.t('report.actions')}</th></tr>
                                `;
                                for (const ctrl of cov.full_coverage) {
                                    const evidenceItems = ctrl.evidence || [];
                                    let evidenceHtml = '';
                                    for (const ev of evidenceItems) {
                                        const excerpt = ev.evidence?.relevant_excerpt || '';
                                        const summary = ev.evidence?.evidence_summary || '';
                                        const strengthTier = ev.evidence?.evidence_strength_tier || 7;
                                        const strengthLabel = this.getStrengthLabel(strengthTier);
                                        const isMachineVerifiable = strengthTier <= 4;
                                        evidenceHtml += `
                                            <div style="margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid #e5e7eb">
                                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:0.25rem">
                                                    <span style="font-size:0.75rem;color:#059669;font-weight:500"><i class="fas fa-file-alt"></i> ${ev.document || this.t('report.unknown')}</span>
                                                    <span class="strength-badge strength-${strengthTier}">${strengthLabel}</span>
                                                    ${isMachineVerifiable ? `<span class="machine-verifiable-badge"><i class="fas fa-robot"></i> ${this.t('report.machine_verifiable')}</span>` : `<span class="human-curated-badge"><i class="fas fa-user"></i> ${this.t('report.human_curated')}</span>`}
                                                </div>
                                                <p style="margin:0 0 0.5rem 0;font-size:0.875rem">${summary}</p>
                                                ${excerpt ? `<blockquote style="margin:0;padding:0.5rem;background:#f0fdf4;border-left:3px solid #059669;font-style:italic;font-size:0.85rem">"${excerpt}"</blockquote>` : ''}
                                            </div>
                                        `;
                                    }
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `
                                        <tr>
                                            <td style="vertical-align:top"><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td>${evidenceHtml || `<em style="color:#9ca3af">${this.t('report.no_evidence_details')}</em>`}</td>
                                            <td style="vertical-align:top">
                                                <button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-bottom:4px;display:block;width:100%" title="${this.t('report.mark_not_applicable')}"><i class="fas fa-ban"></i> ${this.lang === 'fr' ? 'S.O.' : 'N/A'}</button>
                                                <button onclick="window.dispatchEvent(new CustomEvent('reject-evidence', {detail: ${ctrlJson}}))" style="background:#fef3c7;color:#92400e;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;display:block;width:100%" title="${this.t('report.reject_evidence')}"><i class="fas fa-times-circle"></i> ${this.t('report.reject_evidence')}</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }

                            // Controls with partial evidence
                            if (cov.partial_coverage && cov.partial_coverage.length > 0) {
                                html += `
                                    <h2>${this.t('report.controls_partial')} (${cov.partial_coverage.length})</h2>
                                    <p style="color:#d97706">${this.t('report.partial_note')}</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#d97706;font-weight:500;margin-bottom:10px;">${this.t('report.details_toggle')}</summary>
                                        <table><tr><th style="width:120px">${this.t('report.control')}</th><th>${this.t('report.evidence')}</th><th style="width:140px">${this.t('report.actions')}</th></tr>
                                `;
                                for (const ctrl of cov.partial_coverage) {
                                    const evidenceItems = ctrl.evidence || [];
                                    let evidenceHtml = '';
                                    for (const ev of evidenceItems) {
                                        const excerpt = ev.evidence?.relevant_excerpt || '';
                                        const summary = ev.evidence?.evidence_summary || '';
                                        const strengthTier = ev.evidence?.evidence_strength_tier || 7;
                                        const strengthLabel = this.getStrengthLabel(strengthTier);
                                        const isMachineVerifiable = strengthTier <= 4;
                                        evidenceHtml += `
                                            <div style="margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid #e5e7eb">
                                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:0.25rem">
                                                    <span style="font-size:0.75rem;color:#d97706;font-weight:500"><i class="fas fa-file-alt"></i> ${ev.document || this.t('report.unknown')}</span>
                                                    <span class="strength-badge strength-${strengthTier}">${strengthLabel}</span>
                                                    ${isMachineVerifiable ? `<span class="machine-verifiable-badge"><i class="fas fa-robot"></i> ${this.t('report.machine_verifiable')}</span>` : `<span class="human-curated-badge"><i class="fas fa-user"></i> ${this.t('report.human_curated')}</span>`}
                                                </div>
                                                <p style="margin:0 0 0.5rem 0;font-size:0.875rem">${summary}</p>
                                                ${excerpt ? `<blockquote style="margin:0;padding:0.5rem;background:#fef9c3;border-left:3px solid #d97706;font-style:italic;font-size:0.85rem">"${excerpt}"</blockquote>` : ''}
                                            </div>
                                        `;
                                    }
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `
                                        <tr>
                                            <td style="vertical-align:top"><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td>${evidenceHtml || `<em style="color:#9ca3af">${this.t('report.no_evidence_details')}</em>`}</td>
                                            <td style="vertical-align:top">
                                                <button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-bottom:4px;display:block;width:100%" title="${this.t('report.mark_not_applicable')}"><i class="fas fa-ban"></i> ${this.lang === 'fr' ? 'S.O.' : 'N/A'}</button>
                                                <button onclick="window.dispatchEvent(new CustomEvent('reject-evidence', {detail: ${ctrlJson}}))" style="background:#fef3c7;color:#92400e;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;display:block;width:100%" title="${this.t('report.reject_evidence')}"><i class="fas fa-times-circle"></i> ${this.t('report.reject_evidence')}</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }

                            // Controls missing evidence
                            if (cov.no_coverage && cov.no_coverage.length > 0) {
                                html += `
                                    <h2>${this.t('report.controls_missing')} (${cov.no_coverage.length})</h2>
                                    <p style="color:#dc2626"><strong>${cov.no_coverage.length} ${this.t('report.controls')}</strong> ${this.t('report.controls_missing_note')}</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#dc2626;font-weight:500;margin-bottom:10px;">${this.t('report.details_toggle')}</summary>
                                        <table><tr><th style="width:100px">${this.t('report.control_id')}</th><th>${this.t('report.control')}</th><th style="width:60px">${this.t('report.family')}</th><th style="width:80px">${this.t('report.action')}</th></tr>
                                `;
                                for (const ctrl of cov.no_coverage) {
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `<tr><td><strong>${ctrl.control_id}</strong></td><td>${ctrl.control_name}</td><td>${this.getControlFamilyName(ctrl.family)}</td><td><button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem" title="${this.t('report.mark_not_applicable')}"><i class="fas fa-ban"></i> ${this.lang === 'fr' ? 'S.O.' : 'N/A'}</button></td></tr>`;
                                }
                                html += `</table></details>`;
                            }

                            // Not Applicable controls
                            const notApplicable = cov.not_applicable || [];
                            if (notApplicable.length > 0) {
                                // Separate auto-determined vs manually marked
                                const autoNA = notApplicable.filter(c => c.auto_determined === true);
                                const manualNA = notApplicable.filter(c => c.auto_determined === false);

                                html += `
                                    <h2>${this.t('report.not_applicable_controls')} (${notApplicable.length})</h2>
                                    <p style="color:#3b82f6">${this.t('report.not_applicable_note')}</p>
                                `;

                                // Auto-determined section
                                if (autoNA.length > 0) {
                                    html += `
                                        <h3 style="font-size:1rem;color:#6366f1;margin-top:1rem"><i class="fas fa-robot"></i> ${this.t('report.auto_determined')} (${autoNA.length})</h3>
                                        <p style="font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem">${this.t('report.auto_reason')}</p>
                                        <details>
                                            <summary style="cursor:pointer;color:#6366f1;font-weight:500;margin-bottom:10px;">${this.t('report.details_toggle')}</summary>
                                            <table><tr><th style="width:120px">${this.t('report.control')}</th><th>${this.t('report.reason')}</th><th style="width:80px">${this.t('report.action')}</th></tr>
                                    `;
                                    for (const ctrl of autoNA) {
                                        html += `
                                            <tr>
                                                <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                                <td><span style="display:inline-block;background:#e0e7ff;color:#4338ca;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-bottom:4px"><i class="fas fa-robot"></i> ${this.t('report.auto_label')}</span><br>${ctrl.not_applicable_reason || `<em style="color:#9ca3af">${this.t('report.no_reason')}</em>`}</td>
                                                <td>
                                                    <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="${this.t('report.restore_tooltip')}"><i class="fas fa-undo"></i> ${this.t('report.restore')}</button>
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    html += `</table></details>`;
                                }

                                // Manually marked section
                                if (manualNA.length > 0) {
                                    html += `
                                        <h3 style="font-size:1rem;color:#3b82f6;margin-top:1rem"><i class="fas fa-user"></i> ${this.t('report.manual_marked')} (${manualNA.length})</h3>
                                        <p style="font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem">${this.t('report.manual_reason')}</p>
                                        <details open>
                                            <summary style="cursor:pointer;color:#3b82f6;font-weight:500;margin-bottom:10px;">${this.t('report.details_toggle')}</summary>
                                            <table><tr><th style="width:120px">${this.t('report.control')}</th><th>${this.t('report.reason')}</th><th style="width:80px">${this.t('report.action')}</th></tr>
                                    `;
                                    for (const ctrl of manualNA) {
                                        html += `
                                            <tr>
                                                <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                                <td><span style="display:inline-block;background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-bottom:4px"><i class="fas fa-user"></i> ${this.t('report.manual_label')}</span><br>${ctrl.not_applicable_reason || `<em style="color:#9ca3af">${this.t('report.no_reason')}</em>`}</td>
                                                <td>
                                                    <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="${this.t('report.restore_tooltip')}"><i class="fas fa-undo"></i> ${this.t('report.restore')}</button>
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    html += `</table></details>`;
                                }
                            }

                            // Rejected Evidence controls (applicable but evidence insufficient)
                            const rejectedEvidence = cov.rejected_evidence || [];
                            if (rejectedEvidence.length > 0) {
                                html += `
                                    <h2>${this.t('report.rejected_evidence')} (${rejectedEvidence.length})</h2>
                                    <p style="color:#d97706">${this.t('report.rejected_note')}</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#d97706;font-weight:500;margin-bottom:10px;">${this.t('report.details_toggle')}</summary>
                                        <table><tr><th style="width:120px">${this.t('report.control')}</th><th style="width:80px">${this.t('report.had')}</th><th>${this.t('report.rejection_reason')}</th><th style="width:80px">${this.t('report.action')}</th></tr>
                                `;
                                for (const ctrl of rejectedEvidence) {
                                    const originalStatus = ctrl.rejected_from === 'full_coverage' ? this.t('report.summary_full') : this.t('report.summary_partial');
                                    const statusColor = ctrl.rejected_from === 'full_coverage' ? '#059669' : '#d97706';
                                    html += `
                                        <tr>
                                            <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td><span style="color:${statusColor}">${originalStatus}</span></td>
                                            <td>${ctrl.rejection_reason || `<em style="color:#9ca3af">${this.t('report.no_reason')}</em>`}</td>
                                            <td>
                                                <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="${this.t('report.restore_evidence')}"><i class="fas fa-undo"></i> ${this.t('report.restore')}</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }
                        }

                        // Recommendations
                        if (r.phases.recommendations) {
                            const rec = r.phases.recommendations;
                            html += `<h2>${this.t('report.recommendations')}</h2>`;

                            if (rec.high_priority && rec.high_priority.length > 0) {
                                html += `
                                    <h3><span class="severity-critical">${this.t('report.high_priority')}</span></h3>
                                    <p>${this.t('report.address_first')}</p>
                                    <table><tr><th>${this.t('report.control')}</th><th>${this.t('report.action')}</th><th>${this.t('report.suggested_evidence')}</th></tr>
                                `;
                                for (const item of rec.high_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || ''}</td><td>${item.suggested_evidence || ''}</td></tr>`;
                                }
                                html += `</table>`;
                            }

                            if (rec.medium_priority && rec.medium_priority.length > 0) {
                                html += `
                                    <h3><span class="severity-high">${this.t('report.medium_priority')}</span></h3>
                                    <table><tr><th>${this.t('report.control')}</th><th>${this.t('report.action')}</th></tr>
                                `;
                                for (const item of rec.medium_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || ''}</td></tr>`;
                                }
                                html += `</table>`;
                            }

                            if (rec.low_priority && rec.low_priority.length > 0) {
                                html += `
                                    <h3><span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:4px;">${this.t('report.low_priority')} (${rec.low_priority.length})</span></h3>
                                    <p>${this.t('report.low_priority_note')}</p>
                                    <details>
                                        <summary style="cursor:pointer;color:#065f46;font-weight:500;margin-bottom:10px;">${this.t('report.details_show_all')} ${rec.low_priority.length} ${this.t('report.low_priority_controls')}</summary>
                                        <table><tr><th>${this.t('report.control')}</th><th>${this.t('report.action')}</th></tr>
                                `;
                                for (const item of rec.low_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || this.t('report.provide_documentation')}</td></tr>`;
                                }
                                html += `</table></details>`;
                            } else if (rec.low_priority_count > 0) {
                                html += `<p><strong>${rec.low_priority_count}</strong> ${this.t('report.additional_low_priority')}</p>`;
                            }

                            if (rec.next_steps && rec.next_steps.length > 0) {
                                html += `<h3>${this.t('report.next_steps')}</h3><ul>`;
                                for (const step of rec.next_steps) {
                                    html += `<li>${step}</li>`;
                                }
                                html += `</ul>`;
                            }

                            if (rec.missing_by_family) {
                                html += `<h3>${this.t('report.missing_by_family')}</h3><table><tr><th>${this.t('report.family')}</th><th>${this.t('report.missing_controls')}</th></tr>`;
                                for (const [family, count] of Object.entries(rec.missing_by_family)) {
                                    html += `<tr><td><strong>${this.getControlFamilyName(family)}</strong></td><td>${count}</td></tr>`;
                                }
                                html += `</table>`;
                            }
                        }
                    }

                    // Handle error
                    if (r.error) {
                        html += `
                            <h2 style="color:#dc2626">${this.t('report.assessment_error')}</h2>
                            <p>${r.error}</p>
                        `;
                    }

                    return html;
                },

                getProjectName() {
                    if (this.selectedAssessment && this.selectedAssessment.project_name) {
                        return this.selectedAssessment.project_name;
                    }
                    const match = this.assessments.find(a => a.assessment_id === this.selectedAssessment?.assessment_id);
                    return match?.project_name || this.t('report.unknown_project');
                },

                getClientId() {
                    if (this.selectedAssessment && this.selectedAssessment.client_id) {
                        return this.selectedAssessment.client_id;
                    }
                    const match = this.assessments.find(a => a.assessment_id === this.selectedAssessment?.assessment_id);
                    return match?.client_id || this.t('report.unknown_client');
                },

                getStatusCssClass(status) {
                    const classes = {
                        'created': 'background-color:#e5e7eb;color:#374151;padding:2px 8px;border-radius:4px',
                        'in_progress': 'background-color:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px',
                        'running': 'background-color:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px',
                        'completed': 'background-color:#dcfce7;color:#166534;padding:2px 8px;border-radius:4px',
                        'error': 'background-color:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:4px'
                    };
                    return `style="${classes[status] || ''}"`;
                },

                generateMarkdown() {
                    if (!this.selectedAssessment) return '';

                    const a = this.selectedAssessment;
                    const r = this.assessmentResults;
                    const locale = this.lang === 'fr' ? 'fr-CA' : 'en-CA';
                    const date = new Date().toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });

                    let md = `# ${this.t('report.title')}

## ${this.t('report.executive_summary')}

| ${this.t('report.field')} | ${this.t('report.value')} |
|-------|-------|
| ${this.t('report.assessment_id')} | \`${a.assessment_id || 'N/A'}\` |
| ${this.t('report.project_name')} | **${this.getProjectName()}** |
| ${this.t('report.client')} | ${this.getClientId()} |
| ${this.t('report.status')} | ${this.getStatusLabel(a.status) || this.t('report.unknown')} |
| ${this.t('report.report_date')} | ${date} |
| ${this.t('report.documents_reviewed')} | ${this.formatDocumentsReviewed(a.document_count || 0, a.diagram_count || 0)} |

`;

                    if (a.status === 'completed' && r) {
                        // Summary
                        if (r.summary) {
                            const s = r.summary;
                            md += `## ${this.t('report.summary_title')}

| ${this.t('report.metric')} | ${this.t('report.value')} |
|--------|-------|
| ${this.t('report.security_profile')} | ${this.formatProfileTitle(s.profile || 2)} |
| ${this.t('report.total_controls_required')} | ${s.total_controls || 0} |
| ${this.t('report.summary_full')} | ${s.controls_with_evidence || 0} |
| ${this.t('report.summary_partial')} | ${s.controls_partial || 0} |
| ${this.t('report.controls_missing')} | ${s.controls_missing || 0} |
| **${this.t('report.summary_coverage')}** | **${s.coverage_percentage || 0}%** |

`;
                        }

                        if (r.phases) {
                            // System Analysis
                            if (r.phases.system_analysis) {
                                const sa = r.phases.system_analysis;
                                md += `## ${this.t('report.system_analysis')}

| ${this.t('report.attribute')} | ${this.t('report.value')} |
|-----------|-------|
| ${this.t('report.system_type')} | ${sa.system_type || this.t('report.unknown')} |
| ${this.t('report.data_classification')} | ${sa.data_classification || this.t('report.unknown')} |
| ${this.t('report.confidentiality')} | ${sa.confidentiality || this.t('report.unknown')} |
| ${this.t('report.integrity')} | ${sa.integrity || this.t('report.unknown')} |
| ${this.t('report.availability')} | ${sa.availability || this.t('report.unknown')} |
| ${this.t('report.recommended_profile')} | ${this.formatProfileTitle(sa.recommended_profile || 2)} |

### ${this.t('report.rationale')}

${sa.rationale || this.t('report.no_rationale')}

`;
                            }

                            // Coverage
                            if (r.phases.coverage) {
                                const cov = r.phases.coverage;

                                if (cov.full_coverage && cov.full_coverage.length > 0) {
                                    md += `## ${this.t('report.controls_full')}

| ${this.t('report.control_id')} | ${this.t('report.control')} | ${this.t('report.family')} |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.full_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${this.getControlFamilyName(ctrl.family)} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (cov.partial_coverage && cov.partial_coverage.length > 0) {
                                    md += `## ${this.t('report.controls_partial')} (${cov.partial_coverage.length})

${this.t('report.partial_note')}

| ${this.t('report.control_id')} | ${this.t('report.control')} | ${this.t('report.family')} |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.partial_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${this.getControlFamilyName(ctrl.family)} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (cov.no_coverage && cov.no_coverage.length > 0) {
                                    md += `## ${this.t('report.controls_missing')} (${cov.no_coverage.length})

**${cov.no_coverage.length} ${this.t('report.controls')}** ${this.t('report.controls_missing_note')}

| ${this.t('report.control_id')} | ${this.t('report.control')} | ${this.t('report.family')} |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.no_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${this.getControlFamilyName(ctrl.family)} |\n`;
                                    }
                                    md += '\n';
                                }
                            }

                            // Recommendations
                            if (r.phases.recommendations) {
                                const rec = r.phases.recommendations;
                                md += `## ${this.t('report.recommendations')}

`;
                                if (rec.high_priority && rec.high_priority.length > 0) {
                                    md += `### ${this.t('report.high_priority')} (${rec.high_priority.length})

| ${this.t('report.control')} | ${this.t('report.action')} | ${this.t('report.suggested_evidence')} |
|---------|--------|-------------------|
`;
                                    for (const item of rec.high_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} | ${item.suggested_evidence || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.medium_priority && rec.medium_priority.length > 0) {
                                    md += `### ${this.t('report.medium_priority')} (${rec.medium_priority.length})

| ${this.t('report.control')} | ${this.t('report.action')} |
|---------|--------|
`;
                                    for (const item of rec.medium_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.low_priority && rec.low_priority.length > 0) {
                                    md += `### ${this.t('report.low_priority')} (${rec.low_priority.length})

| ${this.t('report.control')} | ${this.t('report.action')} |
|---------|--------|
`;
                                    for (const item of rec.low_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.next_steps && rec.next_steps.length > 0) {
                                    md += `### ${this.t('report.next_steps')}

`;
                                    for (const step of rec.next_steps) {
                                        md += `- ${step}\n`;
                                    }
                                    md += '\n';
                                }
                            }
                        }
                    } else if (a.status === 'created') {
                        md += `## ${this.t('report.assessment_status')}

${this.t('report.created_message')}

### ${this.t('report.next_steps')}

- ${this.t('report.next_steps_upload')}
- ${this.t('report.next_steps_diagrams')}
- ${this.t('report.next_steps_run')}

`;
                    }

                    md += `---

${this.t('markdown.generated')}
`;

                    return md;
                },

                downloadMarkdown() {
                    const markdown = this.generateMarkdown();
                    const blob = new Blob([markdown], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const projectName = this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_');
                    a.download = `ITSG33_Assessment_${projectName}_${new Date().toISOString().split('T')[0]}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                        this.showToast(this.t('toast.markdown_downloaded'), 'success');
                },

                async downloadWord() {
                    if (!this.selectedAssessment) return;
                    const assessmentId = this.selectedAssessment.assessment_id;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/download/word?lang=${this.reportLang}`);
                        if (!response.ok) throw new Error('Download failed');
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ITSG33_Assessment_${this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast(this.t('toast.word_downloaded'), 'success');
                    } catch (error) {
                        this.showToast(this.t('toast.word_download_failed'), 'error');
                    }
                },

                async downloadPOAM() {
                    if (!this.selectedAssessment) return;
                    const assessmentId = this.selectedAssessment.assessment_id;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/download/poam?lang=${this.reportLang}`);
                        if (!response.ok) throw new Error('Download failed');
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `POAM_${this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast(this.t('toast.poam_downloaded'), 'success');
                    } catch (error) {
                        this.showToast(this.t('toast.poam_download_failed'), 'error');
                    }
                },

                async rerunAssessment(assessmentId) {
                    if (!confirm(this.t('toast.rerun_confirm'))) {
                        return;
                    }
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/rerun`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.showToast(`${this.t('toast.rerun_started')} ${data.previous_runs}`, 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast(this.t('toast.rerun_failed'), 'error');
                    }
                },

                async viewHistory(assessmentId) {
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/history`);
                        const data = await response.json();
                        this.assessmentHistory = data;
                        this.showHistoryModal = true;
                    } catch (error) {
                        this.showToast(this.t('toast.history_failed'), 'error');
                    }
                },

                addDocumentsToAssessment(assessment) {
                    this.addDocsAssessment = assessment;
                    this.addDocsFiles = [];
                    this.showAddDocsModal = true;
                },

                async handleAddDocsFiles(event) {
                    await this.uploadAddDocs(event.target.files);
                },

                async handleAddDocsDrop(event) {
                    this.dragover = false;
                    await this.uploadAddDocs(event.dataTransfer.files);
                },

                async uploadAddDocs(files) {
                    if (!this.addDocsAssessment) return;

                    const formData = new FormData();
                    for (const file of files) {
                        formData.append('files', file);
                    }

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.addDocsAssessment.assessment_id}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        this.addDocsFiles = [...this.addDocsFiles, ...data.uploaded_files];
                        this.showToast(this.formatUploadMessage(data.successful), 'success');
                    } catch (error) {
                        this.showToast(this.t('toast.upload_failed'), 'error');
                    }
                },

                async finishAddDocsAndRerun() {
                    if (!this.addDocsAssessment) return;

                    this.showAddDocsModal = false;
                    await this.rerunAssessment(this.addDocsAssessment.assessment_id);
                    this.addDocsAssessment = null;
                    this.addDocsFiles = [];
                },

                closeAddDocsModal() {
                    this.showAddDocsModal = false;
                    this.addDocsAssessment = null;
                    this.addDocsFiles = [];
                    this.loadAssessments();
                },

                getStatusClass(status) {
                    const classes = {
                        'created': 'bg-gray-100 text-gray-800',
                        'in_progress': 'bg-blue-100 text-blue-800',
                        'running': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'error': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const locale = this.lang === 'fr' ? 'fr-CA' : 'en-CA';
                    return new Date(dateString).toLocaleDateString(locale, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                },

                openRejectModal(control, action) {
                    this.rejectingControl = control;
                    this.rejectAction = action;  // 'reject_evidence' or 'not_applicable'
                    this.rejectReason = '';
                    this.rejectError = '';
                    this.showRejectModal = true;
                },

                closeRejectModal() {
                    this.showRejectModal = false;
                    this.rejectingControl = null;
                    this.rejectAction = 'reject_evidence';
                    this.rejectReason = '';
                    this.rejectError = '';
                },

                async confirmRejectAction() {
                    if (!this.rejectingControl || !this.selectedAssessment) return;

                    // Validate reason is provided
                    if (!this.rejectReason.trim()) {
                        this.rejectError = this.t('toast.reject_reason_required');
                        return;
                    }
                    this.rejectError = '';

                    const assessmentId = this.selectedAssessment.assessment_id;
                    const controlId = this.rejectingControl.control_id;
                    const endpoint = this.rejectAction === 'not_applicable'
                        ? `/api/v1/assessment/${assessmentId}/control/${controlId}/not-applicable`
                        : `/api/v1/assessment/${assessmentId}/control/${controlId}/reject-evidence`;

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: this.rejectReason })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Action failed');
                        }

                        const data = await response.json();
                        const message = this.rejectAction === 'not_applicable'
                            ? `${this.t('toast.reject_success_na')} (${controlId})`
                            : `${this.t('toast.reject_success_reject')} (${controlId})`;
                        this.showToast(`${message}. ${this.t('history.coverage')} ${data.new_coverage_percentage}%`, 'success');

                        await this.viewAssessment(assessmentId);
                        this.closeRejectModal();
                    } catch (error) {
                        this.showToast(`${this.t('toast.reject_failed')} ${error.message}`, 'error');
                    }
                },

                async restoreEvidence(controlId) {
                    if (!this.selectedAssessment) return;

                    const assessmentId = this.selectedAssessment.assessment_id;

                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/control/${controlId}/restore`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Restore failed');
                        }

                        const data = await response.json();
                        this.showToast(`${controlId} ${this.t('toast.restore_success')} ${data.new_coverage_percentage}%`, 'success');

                        // Refresh the assessment results
                        await this.viewAssessment(assessmentId);
                    } catch (error) {
                        this.showToast(`${this.t('toast.restore_failed')} ${error.message}`, 'error');
                    }
                },

                getStrengthLabel(tier) {
                    const labels = {
                        1: this.t('strength.system_generated'),
                        2: this.t('strength.iac'),
                        3: this.t('strength.automated_test'),
                        4: this.t('strength.code'),
                        5: this.t('strength.screenshot'),
                        6: this.t('strength.video'),
                        7: this.t('strength.narrative')
                    };
                    return labels[tier] || this.t('report.unknown');
                },

                getStrengthScore(tier) {
                    const scores = {1: 100, 2: 90, 3: 80, 4: 70, 5: 50, 6: 30, 7: 20};
                    return scores[tier] || 20;
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                }
            }
        }
    </script>
</body>
</html>
