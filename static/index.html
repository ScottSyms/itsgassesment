<!DOCTYPE html>
<html lang="en" x-data="app()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSG-33 Accreditation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -10px rgba(0,0,0,0.2);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .markdown-content h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1e3a5f; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #2d5a87; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #374151; }
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content li { margin-bottom: 0.25rem; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .markdown-content th { background-color: #f3f4f6; font-weight: 600; }
        .markdown-content .status-implemented { color: #059669; }
        .markdown-content .status-partial { color: #d97706; }
        .markdown-content .status-not-implemented { color: #dc2626; }
        .markdown-content .severity-critical { background-color: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-high { background-color: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-medium { background-color: #fef9c3; color: #854d0e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content .severity-low { background-color: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; }
        .markdown-content blockquote { margin: 0.5rem 0; padding: 0.75rem; background: #f9fafb; border-left: 3px solid #9ca3af; font-style: italic; font-size: 0.9rem; }
        /* Evidence Strength Badges */
        .strength-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        .strength-1 { background: #dcfce7; color: #166534; }  /* System Generated - Green */
        .strength-2 { background: #d1fae5; color: #065f46; }  /* IaC - Teal */
        .strength-3 { background: #dbeafe; color: #1e40af; }  /* Automated Test - Blue */
        .strength-4 { background: #e0e7ff; color: #4338ca; }  /* Code - Indigo */
        .strength-5 { background: #fef9c3; color: #854d0e; }  /* Screenshot - Yellow */
        .strength-6 { background: #fed7aa; color: #c2410c; }  /* Video - Orange */
        .strength-7 { background: #fee2e2; color: #991b1b; }  /* Narrative - Red */
        .machine-verifiable-badge { color: #059669; font-size: 0.65rem; }
        .human-curated-badge { color: #d97706; font-size: 0.65rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img src="/static/aip.png" alt="Logo" class="h-10 w-auto mr-3 rounded">
                        <div>
                            <span class="font-bold text-xl">ITSG-33 Accreditation</span>
                            <span class="text-xs text-blue-200 block">Security Assessment Platform</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-blue-200">
                        <i class="fas fa-circle text-green-400 text-xs mr-1 pulse-dot"></i>
                        System Operational
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button @click="currentTab = 'dashboard'"
                        :class="currentTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </button>
                <button @click="currentTab = 'new'"
                        :class="currentTab === 'new' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i>New Assessment
                </button>
                <button @click="currentTab = 'assessments'"
                        :class="currentTab === 'assessments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-list mr-2"></i>Assessments
                </button>
                <button @click="currentTab = 'controls'"
                        :class="currentTab === 'controls' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    <i class="fas fa-lock mr-2"></i>Control Families
                </button>
            </nav>
        </div>

        <!-- Dashboard Tab -->
        <div x-show="currentTab === 'dashboard'" x-cloak>
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-clipboard-check text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Assessments</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Completed</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.filter(a => a.status === 'completed').length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-spinner text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">In Progress</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="assessments.filter(a => a.status === 'in_progress' || a.status === 'running').length">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all duration-300">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-shield-alt text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Control Families</p>
                            <p class="text-2xl font-bold text-gray-900">17</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Assessments -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-history mr-2 text-gray-400"></i>Recent Assessments
                </h3>
                <div x-show="assessments.length === 0" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No assessments yet. Create your first assessment to get started.</p>
                    <button @click="currentTab = 'new'" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Assessment
                    </button>
                </div>
                <div x-show="assessments.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="assessment in assessments.slice(0, 5)" :key="assessment.assessment_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="assessment.project_name"></div>
                                        <div class="text-sm text-gray-500" x-text="assessment.assessment_id.slice(0, 8) + '...'"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="assessment.client_id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="getStatusClass(assessment.status)" class="px-2 py-1 text-xs font-medium rounded-full" x-text="assessment.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(assessment.created_at)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewAssessment(assessment.assessment_id)" class="text-blue-600 hover:text-blue-800 mr-3">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Assessment Tab -->
        <div x-show="currentTab === 'new'" x-cloak>
            <div class="bg-white rounded-xl shadow-md p-8 max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    <i class="fas fa-plus-circle mr-2 text-blue-600"></i>Create New Assessment
                </h2>

                <!-- Step Indicator -->
                <div class="flex items-center mb-8">
                    <div class="flex items-center">
                        <div :class="step >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 1 ? 'text-blue-600' : 'text-gray-500'">Details</span>
                    </div>
                    <div class="flex-1 h-1 mx-4" :class="step >= 2 ? 'bg-blue-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 2 ? 'text-blue-600' : 'text-gray-500'">Documents</span>
                    </div>
                    <div class="flex-1 h-1 mx-4" :class="step >= 3 ? 'bg-blue-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center">
                        <div :class="step >= 3 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'" class="w-8 h-8 rounded-full flex items-center justify-center font-bold">3</div>
                        <span class="ml-2 text-sm font-medium" :class="step >= 3 ? 'text-blue-600' : 'text-gray-500'">Run</span>
                    </div>
                </div>

                <!-- Step 1: Details -->
                <div x-show="step === 1">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Client ID *</label>
                            <input type="text" x-model="newAssessment.client_id"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="e.g., DEPT_001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project Name *</label>
                            <input type="text" x-model="newAssessment.project_name"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="e.g., Cloud Migration Project">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Concept of Operations (CONOPS)</label>
                            <textarea x-model="newAssessment.conops" rows="5"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                      placeholder="Describe the system purpose, data types processed, user base, and operational context..."></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button @click="createAssessment()"
                                    :disabled="!newAssessment.client_id || !newAssessment.project_name"
                                    :class="(!newAssessment.client_id || !newAssessment.project_name) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                                    class="px-6 py-3 text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i>Continue to Documents
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Documents -->
                <div x-show="step === 2">
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                Upload security documentation including policies, procedures, architecture diagrams, and configuration evidence.
                            </p>
                        </div>

                        <!-- Drop Zone -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors"
                             @dragover.prevent="dragover = true"
                             @dragleave.prevent="dragover = false"
                             @drop.prevent="handleDrop($event)"
                             :class="dragover ? 'border-blue-500 bg-blue-50' : ''">
                            <input type="file" multiple @change="handleFiles($event)" class="hidden" id="fileInput" accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg">
                            <label for="fileInput" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Drag and drop files here, or <span class="text-blue-600 font-medium">browse</span></p>
                                <p class="text-sm text-gray-400 mt-2">Supports PDF, DOCX, TXT, PNG, JPG</p>
                            </label>
                        </div>

                        <!-- File List -->
                        <div x-show="uploadedFiles.length > 0" class="space-y-2">
                            <h4 class="font-medium text-gray-700">Uploaded Files:</h4>
                            <template x-for="(file, index) in uploadedFiles" :key="index">
                                <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-file text-gray-400 mr-3"></i>
                                        <span class="text-sm text-gray-700" x-text="file.filename"></span>
                                        <span x-show="file.parsed" class="ml-2 text-xs text-green-600">
                                            <i class="fas fa-check-circle"></i> Parsed
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="flex justify-between">
                            <button @click="step = 1" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>Back
                            </button>
                            <button @click="step = 3" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i>Continue
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Run -->
                <div x-show="step === 3">
                    <div class="space-y-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="font-semibold text-green-800 mb-2">
                                <i class="fas fa-check-circle mr-2"></i>Ready to Run Assessment
                            </h4>
                            <div class="text-sm text-green-700 space-y-1">
                                <p><strong>Assessment ID:</strong> <span x-text="currentAssessmentId"></span></p>
                                <p><strong>Project:</strong> <span x-text="newAssessment.project_name"></span></p>
                                <p><strong>Documents:</strong> <span x-text="uploadedFiles.length"></span> files uploaded</p>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                The assessment will analyze your documents against all 17 ITSG-33 control families. This may take several minutes.
                            </p>
                        </div>

                        <div class="flex justify-between">
                            <button @click="step = 2" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>Back
                            </button>
                            <button @click="runAssessment()"
                                    :disabled="isRunning"
                                    :class="isRunning ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                                    class="px-6 py-3 text-white rounded-lg font-medium transition-colors">
                                <template x-if="!isRunning">
                                    <span><i class="fas fa-play mr-2"></i>Run Assessment</span>
                                </template>
                                <template x-if="isRunning">
                                    <span><i class="fas fa-spinner fa-spin mr-2"></i>Running...</span>
                                </template>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessments Tab -->
        <div x-show="currentTab === 'assessments'" x-cloak>
            <div class="bg-white rounded-xl shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-list mr-2 text-gray-400"></i>All Assessments
                        </h2>
                        <button @click="loadAssessments()" class="px-4 py-2 text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <div x-show="assessments.length === 0" class="p-8 text-center text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-3"></i>
                    <p>No assessments found.</p>
                </div>

                <div x-show="assessments.length > 0" class="divide-y divide-gray-200">
                    <template x-for="assessment in assessments" :key="assessment.assessment_id">
                        <div class="p-6 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="text-lg font-medium text-gray-900" x-text="assessment.project_name"></h3>
                                        <span :class="getStatusClass(assessment.status)" class="ml-3 px-2 py-1 text-xs font-medium rounded-full" x-text="assessment.status"></span>
                                    </div>
                                    <div class="mt-1 text-sm text-gray-500">
                                        <span><i class="fas fa-building mr-1"></i><span x-text="assessment.client_id"></span></span>
                                        <span class="mx-2">|</span>
                                        <span><i class="fas fa-calendar mr-1"></i><span x-text="formatDate(assessment.created_at)"></span></span>
                                        <span class="mx-2">|</span>
                                        <span class="text-xs text-gray-400" x-text="assessment.assessment_id"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button @click="viewAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button x-show="assessment.status === 'created'"
                                            @click="selectAssessmentForRun(assessment)"
                                            class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                                        <i class="fas fa-play mr-1"></i>Run
                                    </button>
                                    <button x-show="assessment.status === 'completed'"
                                            @click="addDocumentsToAssessment(assessment)"
                                            class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm">
                                        <i class="fas fa-file-upload mr-1"></i>Add Docs
                                    </button>
                                    <button x-show="assessment.status === 'completed'"
                                            @click="rerunAssessment(assessment.assessment_id)"
                                            class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm">
                                        <i class="fas fa-redo mr-1"></i>Rerun
                                    </button>
                                    <button x-show="assessment.status === 'completed'"
                                            @click="viewHistory(assessment.assessment_id)"
                                            class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm">
                                        <i class="fas fa-history mr-1"></i>History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Control Families Tab -->
        <div x-show="currentTab === 'controls'" x-cloak>
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-lock mr-2 text-gray-400"></i>ITSG-33 Control Families
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="family in controlFamilies" :key="family.code">
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                                    <span x-text="family.code"></span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-medium text-gray-900" x-text="family.name"></h4>
                                    <p class="text-sm text-gray-500" x-text="family.code + ' Controls'"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Profiles -->
            <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-layer-group mr-2 text-gray-400"></i>Security Profiles
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <template x-for="profile in profiles" :key="profile.number">
                        <div class="border-2 rounded-lg p-6 text-center"
                             :class="profile.number === 1 ? 'border-green-300 bg-green-50' : profile.number === 2 ? 'border-yellow-300 bg-yellow-50' : 'border-red-300 bg-red-50'">
                            <div class="text-3xl font-bold mb-2"
                                 :class="profile.number === 1 ? 'text-green-600' : profile.number === 2 ? 'text-yellow-600' : 'text-red-600'"
                                 x-text="'Profile ' + profile.number"></div>
                            <div class="font-medium text-gray-900" x-text="profile.name.split(' - ')[1]"></div>
                            <p class="text-sm text-gray-600 mt-2" x-text="profile.description"></p>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Assessment Detail Modal -->
        <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showModal = false">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = false"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-5xl w-full mx-auto z-10 max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <div class="flex items-center">
                            <img src="/static/aip.png" alt="Logo" class="h-8 w-auto mr-3 rounded">
                            <h3 class="text-xl font-semibold text-gray-900">
                                Assessment Report
                            </h3>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="downloadMarkdown()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm" title="Download Markdown">
                                <i class="fas fa-file-alt mr-1"></i>MD
                            </button>
                            <button @click="downloadWord()" x-show="selectedAssessment?.status === 'completed'" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm" title="Download Word Document">
                                <i class="fas fa-file-word mr-1"></i>Word
                            </button>
                            <button @click="downloadPOAM()" x-show="selectedAssessment?.status === 'completed'" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm" title="Download POA&M">
                                <i class="fas fa-tasks mr-1"></i>POA&M
                            </button>
                            <button @click="showModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="selectedAssessment">
                            <div class="markdown-content" x-html="renderAssessmentReport()"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div x-show="showHistoryModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showHistoryModal = false">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showHistoryModal = false"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full mx-auto z-10 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-history mr-2 text-purple-600"></i>Assessment Run History
                        </h3>
                        <button @click="showHistoryModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="assessmentHistory">
                            <div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Total Runs: <strong x-text="assessmentHistory.total_runs"></strong>
                                </p>

                                <!-- Current Run -->
                                <template x-if="assessmentHistory.current_run">
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-gray-800 mb-2">Current Run</h4>
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="text-sm font-medium text-green-800">Run #<span x-text="assessmentHistory.current_run.run_id"></span></span>
                                                        <span class="px-2 py-1 bg-green-200 text-green-800 text-xs font-medium rounded-full">Current</span>
                                                    </div>
                                                    <p class="text-xs text-green-600">
                                                        Completed: <span x-text="formatDate(assessmentHistory.current_run.completed_at)"></span>
                                                    </p>
                                                    <p class="text-xs text-green-600 mb-3">
                                                        Documents: <span x-text="assessmentHistory.current_run.document_count"></span>
                                                    </p>
                                                    <!-- Controls Summary -->
                                                    <div class="bg-white rounded-lg p-3 border border-green-100">
                                                        <p class="text-xs font-semibold text-gray-700 mb-2">Controls Summary</p>
                                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                                            <div>
                                                                <span class="text-gray-500">Total Assessed:</span>
                                                                <span class="font-medium text-gray-800" x-text="assessmentHistory.current_run.total_controls || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500">Full Evidence:</span>
                                                                <span class="font-medium text-green-600" x-text="assessmentHistory.current_run.controls_with_evidence || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500">Partial:</span>
                                                                <span class="font-medium text-yellow-600" x-text="assessmentHistory.current_run.controls_partial || 0"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-gray-500">Missing:</span>
                                                                <span class="font-medium text-red-600" x-text="assessmentHistory.current_run.controls_missing || 0"></span>
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 pt-2 border-t border-green-100">
                                                            <div class="flex items-center justify-between">
                                                                <span class="text-xs text-gray-500">Coverage:</span>
                                                                <span class="text-sm font-bold" :class="assessmentHistory.current_run.coverage_percentage >= 80 ? 'text-green-600' : assessmentHistory.current_run.coverage_percentage >= 50 ? 'text-yellow-600' : 'text-red-600'" x-text="(assessmentHistory.current_run.coverage_percentage || 0) + '%'"></span>
                                                            </div>
                                                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                                                <div class="h-1.5 rounded-full" :class="assessmentHistory.current_run.coverage_percentage >= 80 ? 'bg-green-500' : assessmentHistory.current_run.coverage_percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'" :style="'width: ' + (assessmentHistory.current_run.coverage_percentage || 0) + '%'"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Historical Runs -->
                                <template x-if="assessmentHistory.history && assessmentHistory.history.length > 0">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-2">Previous Runs</h4>
                                        <div class="space-y-3">
                                            <template x-for="run in assessmentHistory.history" :key="run.run_id">
                                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                                    <div class="flex justify-between items-start">
                                                        <div class="flex-1">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <span class="text-sm font-medium text-gray-800">Run #<span x-text="run.run_id"></span></span>
                                                                <span class="px-2 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded-full">Archived</span>
                                                            </div>
                                                            <p class="text-xs text-gray-600">
                                                                Completed: <span x-text="formatDate(run.completed_at)"></span>
                                                            </p>
                                                            <p class="text-xs text-gray-600 mb-3">
                                                                Documents: <span x-text="run.document_count"></span>
                                                            </p>
                                                            <!-- Controls Summary -->
                                                            <div class="bg-white rounded-lg p-3 border border-gray-100">
                                                                <p class="text-xs font-semibold text-gray-700 mb-2">Controls Summary</p>
                                                                <div class="grid grid-cols-2 gap-2 text-xs">
                                                                    <div>
                                                                        <span class="text-gray-500">Total Assessed:</span>
                                                                        <span class="font-medium text-gray-800" x-text="run.total_controls || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500">Full Evidence:</span>
                                                                        <span class="font-medium text-green-600" x-text="run.controls_with_evidence || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500">Partial:</span>
                                                                        <span class="font-medium text-yellow-600" x-text="run.controls_partial || 0"></span>
                                                                    </div>
                                                                    <div>
                                                                        <span class="text-gray-500">Missing:</span>
                                                                        <span class="font-medium text-red-600" x-text="run.controls_missing || 0"></span>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-2 pt-2 border-t border-gray-100">
                                                                    <div class="flex items-center justify-between">
                                                                        <span class="text-xs text-gray-500">Coverage:</span>
                                                                        <span class="text-sm font-bold" :class="run.coverage_percentage >= 80 ? 'text-green-600' : run.coverage_percentage >= 50 ? 'text-yellow-600' : 'text-red-600'" x-text="(run.coverage_percentage || 0) + '%'"></span>
                                                                    </div>
                                                                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                                                        <div class="h-1.5 rounded-full" :class="run.coverage_percentage >= 80 ? 'bg-green-500' : run.coverage_percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'" :style="'width: ' + (run.coverage_percentage || 0) + '%'"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="!assessmentHistory.history || assessmentHistory.history.length === 0">
                                    <p class="text-gray-500 text-sm">No previous runs. This is the first assessment run.</p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Documents Modal -->
        <div x-show="showAddDocsModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="closeAddDocsModal()">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeAddDocsModal()"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full mx-auto z-10 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-file-upload mr-2 text-indigo-600"></i>Add Documents to Assessment
                        </h3>
                        <button @click="closeAddDocsModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                        <template x-if="addDocsAssessment">
                            <div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Adding documents to: <strong x-text="addDocsAssessment.project_name"></strong>
                                </p>

                                <!-- Drop Zone -->
                                <div class="border-2 border-dashed rounded-xl p-8 text-center transition-colors mb-6"
                                     :class="dragover ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300 hover:border-indigo-400'"
                                     @dragover.prevent="dragover = true"
                                     @dragleave.prevent="dragover = false"
                                     @drop.prevent="handleAddDocsDrop($event)">
                                    <i class="fas fa-cloud-upload-alt text-4xl mb-4" :class="dragover ? 'text-indigo-500' : 'text-gray-400'"></i>
                                    <p class="text-gray-600 mb-2">Drag & drop files here or</p>
                                    <label class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg cursor-pointer hover:bg-indigo-700 transition-colors">
                                        <i class="fas fa-folder-open mr-2"></i>Browse Files
                                        <input type="file" multiple accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg"
                                               class="hidden" @change="handleAddDocsFiles($event)">
                                    </label>
                                    <p class="text-xs text-gray-500 mt-3">Supported: PDF, DOCX, TXT, PNG, JPG</p>
                                </div>

                                <!-- Uploaded Files List -->
                                <template x-if="addDocsFiles.length > 0">
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-gray-800 mb-2">Uploaded Files</h4>
                                        <div class="space-y-2">
                                            <template x-for="file in addDocsFiles" :key="file.file_id">
                                                <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-file text-green-600 mr-3"></i>
                                                        <span class="text-sm text-gray-700" x-text="file.filename"></span>
                                                    </div>
                                                    <i class="fas fa-check-circle text-green-600"></i>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end space-x-3 flex-shrink-0">
                        <button @click="closeAddDocsModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            Cancel
                        </button>
                        <button @click="finishAddDocsAndRerun()"
                                :disabled="addDocsFiles.length === 0"
                                :class="addDocsFiles.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'"
                                class="px-4 py-2 text-white rounded-lg transition-colors">
                            <i class="fas fa-redo mr-2"></i>Add & Rerun Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reject/Not Applicable Modal -->
        <div x-show="showRejectModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="closeRejectModal()">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeRejectModal()"></div>

                <div class="relative bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto z-10">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-xl">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <template x-if="rejectAction === 'not_applicable'">
                                <span><i class="fas fa-ban mr-2 text-blue-600"></i>Mark Not Applicable</span>
                            </template>
                            <template x-if="rejectAction === 'reject_evidence'">
                                <span><i class="fas fa-times-circle mr-2 text-orange-600"></i>Reject Evidence</span>
                            </template>
                        </h3>
                        <button @click="closeRejectModal()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <template x-if="rejectingControl">
                            <div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>Control ID:</strong> <span class="font-mono text-gray-900" x-text="rejectingControl.control_id"></span>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong>Control Name:</strong> <span x-text="rejectingControl.control_name"></span>
                                    </p>
                                </div>

                                <!-- Context message based on action -->
                                <div class="mb-4 p-4 rounded-lg"
                                     :class="rejectAction === 'not_applicable' ? 'bg-blue-50 border border-blue-200' : 'bg-orange-50 border border-orange-200'">
                                    <template x-if="rejectAction === 'not_applicable'">
                                        <p class="text-sm text-blue-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            This control will be marked as <strong>not applicable</strong> to this solution and excluded from coverage calculations.
                                        </p>
                                    </template>
                                    <template x-if="rejectAction === 'reject_evidence'">
                                        <p class="text-sm text-orange-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            The evidence will be rejected as <strong>insufficient</strong>. The control remains applicable and will need better documentation.
                                        </p>
                                    </template>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Reason <span class="text-red-500">*</span>
                                    </label>
                                    <textarea x-model="rejectReason" rows="3"
                                              class="w-full px-4 py-3 border rounded-lg focus:ring-2 transition-colors"
                                              :class="rejectError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-blue-500'"
                                              :placeholder="rejectAction === 'not_applicable' ? 'e.g., This is a cloud-hosted solution with no on-premise infrastructure...' : 'e.g., The document references policies but does not provide implementation details...'"></textarea>
                                    <p x-show="rejectError" class="mt-1 text-sm text-red-600" x-text="rejectError"></p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end space-x-3 rounded-b-xl">
                        <button @click="closeRejectModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            Cancel
                        </button>
                        <button @click="confirmRejectAction()"
                                class="px-4 py-2 text-white rounded-lg transition-colors"
                                :class="rejectAction === 'not_applicable' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-orange-600 hover:bg-orange-700'">
                            <i :class="rejectAction === 'not_applicable' ? 'fas fa-ban mr-2' : 'fas fa-times-circle mr-2'"></i>
                            <span x-text="rejectAction === 'not_applicable' ? 'Mark Not Applicable' : 'Reject Evidence'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div x-show="toast.show" x-cloak
             x-transition:enter="transform ease-out duration-300 transition"
             x-transition:enter-start="translate-y-2 opacity-0"
             x-transition:enter-end="translate-y-0 opacity-100"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed bottom-4 right-4 z-50">
            <div :class="toast.type === 'success' ? 'bg-green-500' : toast.type === 'error' ? 'bg-red-500' : 'bg-blue-500'"
                 class="text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                <i :class="toast.type === 'success' ? 'fas fa-check-circle' : toast.type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle'" class="mr-2"></i>
                <span x-text="toast.message"></span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
            <p>ITSG-33 Accreditation System &bull; Government of Canada IT Security Standard</p>
        </div>
    </footer>

    <script>
        function app() {
            return {
                currentTab: 'dashboard',
                step: 1,
                assessments: [],
                controlFamilies: [],
                profiles: [],
                newAssessment: {
                    client_id: '',
                    project_name: '',
                    conops: ''
                },
                currentAssessmentId: null,
                uploadedFiles: [],
                selectedAssessment: null,
                assessmentResults: null,
                showModal: false,
                showHistoryModal: false,
                showAddDocsModal: false,
                assessmentHistory: null,
                addDocsAssessment: null,
                addDocsFiles: [],
                isRunning: false,
                dragover: false,
                toast: { show: false, message: '', type: 'info' },
                showRejectModal: false,
                rejectingControl: null,
                rejectAction: 'reject_evidence',  // 'reject_evidence' or 'not_applicable'
                rejectReason: '',
                rejectError: '',

                async init() {
                    await this.loadAssessments();
                    await this.loadControlFamilies();
                    await this.loadProfiles();

                    // Listen for reject-evidence events
                    window.addEventListener('reject-evidence', (e) => {
                        this.openRejectModal(e.detail, 'reject_evidence');
                    });

                    // Listen for mark-not-applicable events
                    window.addEventListener('mark-not-applicable', (e) => {
                        this.openRejectModal(e.detail, 'not_applicable');
                    });

                    // Listen for restore-control events
                    window.addEventListener('restore-control', (e) => {
                        this.restoreEvidence(e.detail);
                    });
                },

                async loadAssessments() {
                    try {
                        const response = await fetch('/api/v1/assessments');
                        const data = await response.json();
                        this.assessments = data.assessments || [];
                    } catch (error) {
                        console.error('Failed to load assessments:', error);
                    }
                },

                async loadControlFamilies() {
                    try {
                        const response = await fetch('/api/v1/controls/families');
                        const data = await response.json();
                        this.controlFamilies = data.families || [];
                    } catch (error) {
                        console.error('Failed to load control families:', error);
                    }
                },

                async loadProfiles() {
                    try {
                        const response = await fetch('/api/v1/profiles');
                        const data = await response.json();
                        this.profiles = data.profiles || [];
                    } catch (error) {
                        console.error('Failed to load profiles:', error);
                    }
                },

                async createAssessment() {
                    try {
                        const response = await fetch('/api/v1/assessment/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newAssessment)
                        });
                        const data = await response.json();
                        this.currentAssessmentId = data.assessment_id;
                        this.step = 2;
                        this.showToast('Assessment created successfully!', 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast('Failed to create assessment', 'error');
                    }
                },

                handleFiles(event) {
                    this.uploadFiles(event.target.files);
                },

                handleDrop(event) {
                    this.dragover = false;
                    this.uploadFiles(event.dataTransfer.files);
                },

                async uploadFiles(files) {
                    if (!this.currentAssessmentId) return;

                    const formData = new FormData();
                    for (const file of files) {
                        formData.append('files', file);
                    }

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.currentAssessmentId}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        this.uploadedFiles = [...this.uploadedFiles, ...data.uploaded_files];
                        this.showToast(`${data.successful} file(s) uploaded`, 'success');
                    } catch (error) {
                        this.showToast('Failed to upload files', 'error');
                    }
                },

                async runAssessment() {
                    if (!this.currentAssessmentId) return;
                    this.isRunning = true;

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.currentAssessmentId}/run`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.showToast('Assessment started! This may take a few minutes.', 'success');

                        this.step = 1;
                        this.newAssessment = { client_id: '', project_name: '', conops: '' };
                        this.uploadedFiles = [];
                        this.currentAssessmentId = null;
                        this.currentTab = 'assessments';
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast('Failed to run assessment', 'error');
                    } finally {
                        this.isRunning = false;
                    }
                },

                async viewAssessment(assessmentId) {
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/status`);
                        this.selectedAssessment = await response.json();

                        if (this.selectedAssessment.status === 'completed') {
                            try {
                                const resultsResponse = await fetch(`/api/v1/assessment/${assessmentId}/results`);
                                if (resultsResponse.ok) {
                                    this.assessmentResults = await resultsResponse.json();
                                }
                            } catch (e) {
                                this.assessmentResults = null;
                            }
                        } else {
                            this.assessmentResults = null;
                        }

                        this.showModal = true;
                    } catch (error) {
                        this.showToast('Failed to load assessment details', 'error');
                    }
                },

                selectAssessmentForRun(assessment) {
                    this.currentAssessmentId = assessment.assessment_id;
                    this.newAssessment.project_name = assessment.project_name;
                    this.newAssessment.client_id = assessment.client_id;
                    this.step = 2;
                    this.currentTab = 'new';
                },

                renderAssessmentReport() {
                    if (!this.selectedAssessment) return '';

                    const a = this.selectedAssessment;
                    const r = this.assessmentResults;
                    const date = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' });

                    let html = `
                        <h1>ITSG-33 Security Assessment Report</h1>

                        <h2>Executive Summary</h2>
                        <table>
                            <tr><th style="width:200px">Assessment ID</th><td><code>${a.assessment_id || 'N/A'}</code></td></tr>
                            <tr><th>Project Name</th><td><strong>${this.getProjectName()}</strong></td></tr>
                            <tr><th>Client</th><td>${this.getClientId()}</td></tr>
                            <tr><th>Status</th><td><span class="${this.getStatusCssClass(a.status)}">${a.status || 'Unknown'}</span></td></tr>
                            <tr><th>Report Date</th><td>${date}</td></tr>
                            <tr><th>Documents Reviewed</th><td>${a.document_count || 0} documents, ${a.diagram_count || 0} diagrams</td></tr>
                        </table>
                    `;

                    if (a.status === 'completed' && r) {
                        html += this.renderCompletedResults(r);
                    } else if (a.status === 'created') {
                        html += `
                            <h2>Assessment Status</h2>
                            <p>This assessment has been created but not yet executed. Upload documents and run the assessment to generate results.</p>

                            <h3>Next Steps</h3>
                            <ul>
                                <li>Upload relevant security documentation (policies, procedures, configurations)</li>
                                <li>Include architecture diagrams and network documentation</li>
                                <li>Run the assessment to analyze documents against ITSG-33 controls</li>
                            </ul>
                        `;
                    } else if (a.status === 'in_progress' || a.status === 'running') {
                        html += `
                            <h2>Assessment In Progress</h2>
                            <p>The assessment is currently running. Please check back shortly for results.</p>
                            <p>The system is analyzing your documents against all 17 ITSG-33 control families.</p>
                        `;
                    }

                    html += `
                        <h2>About ITSG-33</h2>
                        <p>ITSG-33 (IT Security Risk Management: A Lifecycle Approach) is the Government of Canada's framework for managing IT security risks. It defines security controls across 17 families:</p>
                        <ul>
                            <li><strong>AC</strong> - Access Control</li>
                            <li><strong>AT</strong> - Awareness and Training</li>
                            <li><strong>AU</strong> - Audit and Accountability</li>
                            <li><strong>CA</strong> - Assessment, Authorization, and Monitoring</li>
                            <li><strong>CM</strong> - Configuration Management</li>
                            <li><strong>CP</strong> - Contingency Planning</li>
                            <li><strong>IA</strong> - Identification and Authentication</li>
                            <li><strong>IR</strong> - Incident Response</li>
                            <li><strong>MA</strong> - Maintenance</li>
                            <li><strong>MP</strong> - Media Protection</li>
                            <li><strong>PE</strong> - Physical and Environmental Protection</li>
                            <li><strong>PL</strong> - Planning</li>
                            <li><strong>PS</strong> - Personnel Security</li>
                            <li><strong>RA</strong> - Risk Assessment</li>
                            <li><strong>SA</strong> - System and Services Acquisition</li>
                            <li><strong>SC</strong> - System and Communications Protection</li>
                            <li><strong>SI</strong> - System and Information Integrity</li>
                        </ul>
                    `;

                    return html;
                },

                renderCompletedResults(r) {
                    let html = '';

                    // Summary section
                    if (r.summary) {
                        const s = r.summary;
                        const coveragePct = s.coverage_percentage || 0;
                        const coverageColor = coveragePct >= 70 ? '#059669' : coveragePct >= 40 ? '#d97706' : '#dc2626';

                        const notApplicableList = r.phases?.coverage?.not_applicable || [];
                        const rejectedEvidenceList = r.phases?.coverage?.rejected_evidence || [];
                        const notApplicableCount = notApplicableList.length;
                        const autoNACount = notApplicableList.filter(c => c.auto_determined === true).length;
                        const manualNACount = notApplicableList.filter(c => c.auto_determined === false).length;
                        const rejectedEvidenceCount = rejectedEvidenceList.length;
                        html += `
                            <h2>Assessment Summary</h2>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem">
                                <div style="background:#f0fdf4;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#059669">${s.controls_with_evidence || 0}</div>
                                    <div style="font-size:0.875rem;color:#166534">Full Evidence</div>
                                </div>
                                <div style="background:#fef9c3;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#d97706">${s.controls_partial || 0}</div>
                                    <div style="font-size:0.875rem;color:#92400e">Partial Evidence</div>
                                </div>
                                <div style="background:#fee2e2;padding:1rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:2rem;font-weight:bold;color:#dc2626">${(s.controls_missing || 0) + rejectedEvidenceCount}</div>
                                    <div style="font-size:0.875rem;color:#991b1b">Needs Evidence</div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.5rem">
                                <div style="background:#dbeafe;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#1e40af">${notApplicableCount}</div>
                                    <div style="font-size:0.75rem;color:#3b82f6">Not Applicable</div>
                                    <div style="font-size:0.65rem;color:#6b7280;margin-top:2px"><i class="fas fa-robot"></i> ${autoNACount} auto / <i class="fas fa-user"></i> ${manualNACount} manual</div>
                                </div>
                                <div style="background:#fef3c7;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#92400e">${rejectedEvidenceCount}</div>
                                    <div style="font-size:0.75rem;color:#d97706">Evidence Rejected</div>
                                </div>
                                <div style="background:#f3f4f6;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:${coverageColor}">${coveragePct}%</div>
                                    <div style="font-size:0.75rem;color:#6b7280">Coverage</div>
                                </div>
                                <div style="background:#e0f2fe;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#0369a1">${s.quality_score || 0}%</div>
                                    <div style="font-size:0.75rem;color:#0284c7">Evidence Quality</div>
                                    <div style="font-size:0.65rem;color:#6b7280;margin-top:2px"><i class="fas fa-robot"></i> ${s.machine_verifiable_count || 0} / <i class="fas fa-user"></i> ${s.human_curated_count || 0}</div>
                                </div>
                                <div style="background:#e0e7ff;padding:0.75rem;border-radius:0.5rem;text-align:center">
                                    <div style="font-size:1.5rem;font-weight:bold;color:#4338ca">${s.applicable_controls || (s.total_controls - notApplicableCount)}</div>
                                    <div style="font-size:0.75rem;color:#6366f1">Applicable</div>
                                </div>
                            </div>
                            <table>
                                <tr><th style="width:200px">Security Profile</th><td><strong>Profile ${s.profile || 2}</strong> (${s.profile === 1 ? 'Low' : s.profile === 3 ? 'High' : 'Moderate'} Impact)</td></tr>
                                <tr><th>Total Controls Required</th><td>${s.total_controls || 0}</td></tr>
                            </table>
                        `;
                    }

                    if (r.phases) {
                        // System Analysis
                        if (r.phases.system_analysis) {
                            const sa = r.phases.system_analysis;
                            html += `
                                <h2>System Analysis</h2>
                                <table>
                                    <tr><th style="width:200px">System Type</th><td>${sa.system_type || 'Unknown'}</td></tr>
                                    <tr><th>Data Classification</th><td>${sa.data_classification || 'Unknown'}</td></tr>
                                    <tr><th>Confidentiality</th><td>${sa.confidentiality || 'Unknown'}</td></tr>
                                    <tr><th>Integrity</th><td>${sa.integrity || 'Unknown'}</td></tr>
                                    <tr><th>Availability</th><td>${sa.availability || 'Unknown'}</td></tr>
                                    <tr><th>Recommended Profile</th><td><strong>Profile ${sa.recommended_profile || 2}</strong></td></tr>
                                </table>
                                <h3>Rationale</h3>
                                <p>${sa.rationale || 'No rationale provided.'}</p>
                            `;
                        }

                        // Required Controls by Family
                        if (r.phases.required_controls && r.phases.required_controls.controls_by_family) {
                            const cbf = r.phases.required_controls.controls_by_family;
                            html += `
                                <h2>Required Controls by Family</h2>
                                <table>
                                    <tr><th>Family</th><th>Controls</th></tr>
                            `;
                            for (const [family, controls] of Object.entries(cbf)) {
                                html += `<tr><td><strong>${family}</strong></td><td>${controls.length} controls</td></tr>`;
                            }
                            html += `</table>`;
                        }

                        // Evidence Analysis - Document Analysis
                        if (r.phases.evidence_analysis && r.phases.evidence_analysis.document_analyses) {
                            const docs = r.phases.evidence_analysis.document_analyses;
                            html += `
                                <h2>Document Analysis</h2>
                                <p>${docs.length} document(s) analyzed for security evidence:</p>
                            `;

                            for (const doc of docs) {
                                const controlCount = Object.keys(doc.controls_addressed || {}).length;
                                html += `
                                    <h3>${doc.filename || 'Unknown Document'}</h3>
                                    <table>
                                        <tr><th style="width:200px">Document Type</th><td>${doc.document_type || 'Unknown'}</td></tr>
                                        <tr><th>Purpose</th><td>${doc.document_purpose || 'Unknown'}</td></tr>
                                        <tr><th>Controls Addressed</th><td>${controlCount} control(s)</td></tr>
                                        <tr><th>Security Topics</th><td>${(doc.key_security_topics || []).join(', ') || 'None identified'}</td></tr>
                                    </table>
                                `;

                                if (controlCount > 0) {
                                    html += `<h4>Controls Addressed:</h4><table><tr><th>Control</th><th>Coverage</th><th>Evidence</th></tr>`;
                                    for (const [ctrlId, evidence] of Object.entries(doc.controls_addressed)) {
                                        const coverageClass = evidence.coverage === 'FULL' ? 'status-implemented' : evidence.coverage === 'PARTIAL' ? 'status-partial' : 'status-not-implemented';
                                        html += `<tr><td><strong>${ctrlId}</strong></td><td class="${coverageClass}">${evidence.coverage || 'Unknown'}</td><td>${evidence.evidence_summary || ''}</td></tr>`;
                                    }
                                    html += `</table>`;
                                }
                            }
                        }

                        // Coverage Details
                        if (r.phases.coverage) {
                            const cov = r.phases.coverage;

                            // Controls with full evidence
                            if (cov.full_coverage && cov.full_coverage.length > 0) {
                                html += `
                                    <h2>Controls with Full Evidence (${cov.full_coverage.length})</h2>
                                    <details>
                                        <summary style="cursor:pointer;color:#059669;font-weight:500;margin-bottom:10px;">Click to expand full list</summary>
                                        <table><tr><th style="width:120px">Control</th><th>Evidence</th><th style="width:140px">Actions</th></tr>
                                `;
                                for (const ctrl of cov.full_coverage) {
                                    const evidenceItems = ctrl.evidence || [];
                                    let evidenceHtml = '';
                                    for (const ev of evidenceItems) {
                                        const excerpt = ev.evidence?.relevant_excerpt || '';
                                        const summary = ev.evidence?.evidence_summary || '';
                                        const strengthTier = ev.evidence?.evidence_strength_tier || 7;
                                        const strengthLabel = this.getStrengthLabel(strengthTier);
                                        const isMachineVerifiable = strengthTier <= 4;
                                        evidenceHtml += `
                                            <div style="margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid #e5e7eb">
                                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:0.25rem">
                                                    <span style="font-size:0.75rem;color:#059669;font-weight:500"><i class="fas fa-file-alt"></i> ${ev.document || 'Unknown'}</span>
                                                    <span class="strength-badge strength-${strengthTier}">${strengthLabel}</span>
                                                    ${isMachineVerifiable ? '<span class="machine-verifiable-badge"><i class="fas fa-robot"></i> Machine-Verifiable</span>' : '<span class="human-curated-badge"><i class="fas fa-user"></i> Human-Curated</span>'}
                                                </div>
                                                <p style="margin:0 0 0.5rem 0;font-size:0.875rem">${summary}</p>
                                                ${excerpt ? `<blockquote style="margin:0;padding:0.5rem;background:#f0fdf4;border-left:3px solid #059669;font-style:italic;font-size:0.85rem">"${excerpt}"</blockquote>` : ''}
                                            </div>
                                        `;
                                    }
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `
                                        <tr>
                                            <td style="vertical-align:top"><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td>${evidenceHtml || '<em style="color:#9ca3af">No evidence details</em>'}</td>
                                            <td style="vertical-align:top">
                                                <button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-bottom:4px;display:block;width:100%" title="Mark as Not Applicable"><i class="fas fa-ban"></i> N/A</button>
                                                <button onclick="window.dispatchEvent(new CustomEvent('reject-evidence', {detail: ${ctrlJson}}))" style="background:#fef3c7;color:#92400e;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;display:block;width:100%" title="Reject Evidence"><i class="fas fa-times-circle"></i> Reject Evidence</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }

                            // Controls with partial evidence
                            if (cov.partial_coverage && cov.partial_coverage.length > 0) {
                                html += `
                                    <h2>Controls with Partial Evidence (${cov.partial_coverage.length})</h2>
                                    <p style="color:#d97706">These controls have some evidence but need additional documentation:</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#d97706;font-weight:500;margin-bottom:10px;">Click to expand/collapse</summary>
                                        <table><tr><th style="width:120px">Control</th><th>Evidence</th><th style="width:140px">Actions</th></tr>
                                `;
                                for (const ctrl of cov.partial_coverage) {
                                    const evidenceItems = ctrl.evidence || [];
                                    let evidenceHtml = '';
                                    for (const ev of evidenceItems) {
                                        const excerpt = ev.evidence?.relevant_excerpt || '';
                                        const summary = ev.evidence?.evidence_summary || '';
                                        const strengthTier = ev.evidence?.evidence_strength_tier || 7;
                                        const strengthLabel = this.getStrengthLabel(strengthTier);
                                        const isMachineVerifiable = strengthTier <= 4;
                                        evidenceHtml += `
                                            <div style="margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid #e5e7eb">
                                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:0.25rem">
                                                    <span style="font-size:0.75rem;color:#d97706;font-weight:500"><i class="fas fa-file-alt"></i> ${ev.document || 'Unknown'}</span>
                                                    <span class="strength-badge strength-${strengthTier}">${strengthLabel}</span>
                                                    ${isMachineVerifiable ? '<span class="machine-verifiable-badge"><i class="fas fa-robot"></i> Machine-Verifiable</span>' : '<span class="human-curated-badge"><i class="fas fa-user"></i> Human-Curated</span>'}
                                                </div>
                                                <p style="margin:0 0 0.5rem 0;font-size:0.875rem">${summary}</p>
                                                ${excerpt ? `<blockquote style="margin:0;padding:0.5rem;background:#fef9c3;border-left:3px solid #d97706;font-style:italic;font-size:0.85rem">"${excerpt}"</blockquote>` : ''}
                                            </div>
                                        `;
                                    }
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `
                                        <tr>
                                            <td style="vertical-align:top"><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td>${evidenceHtml || '<em style="color:#9ca3af">No evidence details</em>'}</td>
                                            <td style="vertical-align:top">
                                                <button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;margin-bottom:4px;display:block;width:100%" title="Mark as Not Applicable"><i class="fas fa-ban"></i> N/A</button>
                                                <button onclick="window.dispatchEvent(new CustomEvent('reject-evidence', {detail: ${ctrlJson}}))" style="background:#fef3c7;color:#92400e;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem;display:block;width:100%" title="Reject Evidence"><i class="fas fa-times-circle"></i> Reject Evidence</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }

                            // Controls missing evidence
                            if (cov.no_coverage && cov.no_coverage.length > 0) {
                                html += `
                                    <h2>Controls Missing Evidence (${cov.no_coverage.length})</h2>
                                    <p style="color:#dc2626"><strong>${cov.no_coverage.length} controls</strong> require evidence documentation:</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#dc2626;font-weight:500;margin-bottom:10px;">Click to expand/collapse full list</summary>
                                        <table><tr><th style="width:100px">Control ID</th><th>Control Name</th><th style="width:60px">Family</th><th style="width:80px">Action</th></tr>
                                `;
                                for (const ctrl of cov.no_coverage) {
                                    const ctrlJson = JSON.stringify(ctrl).replace(/"/g, '&quot;');
                                    html += `<tr><td><strong>${ctrl.control_id}</strong></td><td>${ctrl.control_name}</td><td>${ctrl.family}</td><td><button onclick="window.dispatchEvent(new CustomEvent('mark-not-applicable', {detail: ${ctrlJson}}))" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.7rem" title="Mark as Not Applicable"><i class="fas fa-ban"></i> N/A</button></td></tr>`;
                                }
                                html += `</table></details>`;
                            }

                            // Not Applicable controls
                            const notApplicable = cov.not_applicable || [];
                            if (notApplicable.length > 0) {
                                // Separate auto-determined vs manually marked
                                const autoNA = notApplicable.filter(c => c.auto_determined === true);
                                const manualNA = notApplicable.filter(c => c.auto_determined === false);

                                html += `
                                    <h2>Not Applicable Controls (${notApplicable.length})</h2>
                                    <p style="color:#3b82f6">These controls do not apply to this solution (excluded from coverage):</p>
                                `;

                                // Auto-determined section
                                if (autoNA.length > 0) {
                                    html += `
                                        <h3 style="font-size:1rem;color:#6366f1;margin-top:1rem"><i class="fas fa-robot"></i> Auto-Determined (${autoNA.length})</h3>
                                        <p style="font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem">Determined by system analysis based on technology/architecture:</p>
                                        <details>
                                            <summary style="cursor:pointer;color:#6366f1;font-weight:500;margin-bottom:10px;">Click to expand/collapse</summary>
                                            <table><tr><th style="width:120px">Control</th><th>Reason</th><th style="width:80px">Action</th></tr>
                                    `;
                                    for (const ctrl of autoNA) {
                                        html += `
                                            <tr>
                                                <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                                <td><span style="display:inline-block;background:#e0e7ff;color:#4338ca;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-bottom:4px"><i class="fas fa-robot"></i> Auto</span><br>${ctrl.not_applicable_reason || '<em style="color:#9ca3af">No reason provided</em>'}</td>
                                                <td>
                                                    <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="Override - mark as applicable"><i class="fas fa-undo"></i> Restore</button>
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    html += `</table></details>`;
                                }

                                // Manually marked section
                                if (manualNA.length > 0) {
                                    html += `
                                        <h3 style="font-size:1rem;color:#3b82f6;margin-top:1rem"><i class="fas fa-user"></i> Manually Marked (${manualNA.length})</h3>
                                        <p style="font-size:0.875rem;color:#6b7280;margin-bottom:0.5rem">Marked by operator as not applicable:</p>
                                        <details open>
                                            <summary style="cursor:pointer;color:#3b82f6;font-weight:500;margin-bottom:10px;">Click to expand/collapse</summary>
                                            <table><tr><th style="width:120px">Control</th><th>Reason</th><th style="width:80px">Action</th></tr>
                                    `;
                                    for (const ctrl of manualNA) {
                                        html += `
                                            <tr>
                                                <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                                <td><span style="display:inline-block;background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-bottom:4px"><i class="fas fa-user"></i> Manual</span><br>${ctrl.not_applicable_reason || '<em style="color:#9ca3af">No reason provided</em>'}</td>
                                                <td>
                                                    <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="Restore to applicable"><i class="fas fa-undo"></i> Restore</button>
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    html += `</table></details>`;
                                }
                            }

                            // Rejected Evidence controls (applicable but evidence insufficient)
                            const rejectedEvidence = cov.rejected_evidence || [];
                            if (rejectedEvidence.length > 0) {
                                html += `
                                    <h2>Rejected Evidence (${rejectedEvidence.length})</h2>
                                    <p style="color:#d97706">These controls are applicable but need better evidence:</p>
                                    <details open>
                                        <summary style="cursor:pointer;color:#d97706;font-weight:500;margin-bottom:10px;">Click to expand/collapse</summary>
                                        <table><tr><th style="width:120px">Control</th><th style="width:80px">Had</th><th>Rejection Reason</th><th style="width:80px">Action</th></tr>
                                `;
                                for (const ctrl of rejectedEvidence) {
                                    const originalStatus = ctrl.rejected_from === 'full_coverage' ? 'Full' : 'Partial';
                                    const statusColor = ctrl.rejected_from === 'full_coverage' ? '#059669' : '#d97706';
                                    html += `
                                        <tr>
                                            <td><strong>${ctrl.control_id}</strong><br><small style="color:#666">${ctrl.control_name}</small></td>
                                            <td><span style="color:${statusColor}">${originalStatus}</span></td>
                                            <td>${ctrl.rejection_reason || '<em style="color:#9ca3af">No reason provided</em>'}</td>
                                            <td>
                                                <button onclick="window.dispatchEvent(new CustomEvent('restore-control', {detail: '${ctrl.control_id}'}))" style="background:#dcfce7;color:#166534;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem" title="Restore evidence"><i class="fas fa-undo"></i> Restore</button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                html += `</table></details>`;
                            }
                        }

                        // Recommendations
                        if (r.phases.recommendations) {
                            const rec = r.phases.recommendations;
                            html += `<h2>Recommendations</h2>`;

                            if (rec.high_priority && rec.high_priority.length > 0) {
                                html += `
                                    <h3><span class="severity-critical">High Priority</span></h3>
                                    <p>Address these controls first:</p>
                                    <table><tr><th>Control</th><th>Action</th><th>Suggested Evidence</th></tr>
                                `;
                                for (const item of rec.high_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || ''}</td><td>${item.suggested_evidence || ''}</td></tr>`;
                                }
                                html += `</table>`;
                            }

                            if (rec.medium_priority && rec.medium_priority.length > 0) {
                                html += `
                                    <h3><span class="severity-high">Medium Priority</span></h3>
                                    <table><tr><th>Control</th><th>Action</th></tr>
                                `;
                                for (const item of rec.medium_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || ''}</td></tr>`;
                                }
                                html += `</table>`;
                            }

                            if (rec.low_priority && rec.low_priority.length > 0) {
                                html += `
                                    <h3><span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:4px;">Low Priority (${rec.low_priority.length})</span></h3>
                                    <p>These controls should be addressed as part of continuous improvement:</p>
                                    <details>
                                        <summary style="cursor:pointer;color:#065f46;font-weight:500;margin-bottom:10px;">Click to show all ${rec.low_priority.length} low-priority controls</summary>
                                        <table><tr><th>Control</th><th>Action</th></tr>
                                `;
                                for (const item of rec.low_priority) {
                                    html += `<tr><td><strong>${item.control_id}</strong></td><td>${item.action || 'Provide required documentation'}</td></tr>`;
                                }
                                html += `</table></details>`;
                            } else if (rec.low_priority_count > 0) {
                                html += `<p><strong>${rec.low_priority_count}</strong> additional low-priority controls need attention.</p>`;
                            }

                            if (rec.next_steps && rec.next_steps.length > 0) {
                                html += `<h3>Next Steps</h3><ul>`;
                                for (const step of rec.next_steps) {
                                    html += `<li>${step}</li>`;
                                }
                                html += `</ul>`;
                            }

                            if (rec.missing_by_family) {
                                html += `<h3>Missing Controls by Family</h3><table><tr><th>Family</th><th>Missing Controls</th></tr>`;
                                for (const [family, count] of Object.entries(rec.missing_by_family)) {
                                    html += `<tr><td><strong>${family}</strong></td><td>${count}</td></tr>`;
                                }
                                html += `</table>`;
                            }
                        }
                    }

                    // Handle error
                    if (r.error) {
                        html += `
                            <h2 style="color:#dc2626">Assessment Error</h2>
                            <p>${r.error}</p>
                        `;
                    }

                    return html;
                },

                getProjectName() {
                    if (this.selectedAssessment && this.selectedAssessment.project_name) {
                        return this.selectedAssessment.project_name;
                    }
                    const match = this.assessments.find(a => a.assessment_id === this.selectedAssessment?.assessment_id);
                    return match?.project_name || 'Unknown Project';
                },

                getClientId() {
                    if (this.selectedAssessment && this.selectedAssessment.client_id) {
                        return this.selectedAssessment.client_id;
                    }
                    const match = this.assessments.find(a => a.assessment_id === this.selectedAssessment?.assessment_id);
                    return match?.client_id || 'Unknown Client';
                },

                getStatusCssClass(status) {
                    const classes = {
                        'created': 'background-color:#e5e7eb;color:#374151;padding:2px 8px;border-radius:4px',
                        'in_progress': 'background-color:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px',
                        'running': 'background-color:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px',
                        'completed': 'background-color:#dcfce7;color:#166534;padding:2px 8px;border-radius:4px',
                        'error': 'background-color:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:4px'
                    };
                    return `style="${classes[status] || ''}"`;
                },

                generateMarkdown() {
                    if (!this.selectedAssessment) return '';

                    const a = this.selectedAssessment;
                    const r = this.assessmentResults;
                    const date = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' });

                    let md = `# ITSG-33 Security Assessment Report

## Executive Summary

| Field | Value |
|-------|-------|
| Assessment ID | \`${a.assessment_id || 'N/A'}\` |
| Project Name | **${this.getProjectName()}** |
| Client | ${this.getClientId()} |
| Status | ${a.status || 'Unknown'} |
| Report Date | ${date} |
| Documents Reviewed | ${a.document_count || 0} documents, ${a.diagram_count || 0} diagrams |

`;

                    if (a.status === 'completed' && r) {
                        // Summary
                        if (r.summary) {
                            const s = r.summary;
                            md += `## Assessment Summary

| Metric | Value |
|--------|-------|
| Security Profile | Profile ${s.profile || 2} |
| Total Controls Required | ${s.total_controls || 0} |
| Controls with Full Evidence | ${s.controls_with_evidence || 0} |
| Controls with Partial Evidence | ${s.controls_partial || 0} |
| Controls Missing Evidence | ${s.controls_missing || 0} |
| **Coverage Percentage** | **${s.coverage_percentage || 0}%** |

`;
                        }

                        if (r.phases) {
                            // System Analysis
                            if (r.phases.system_analysis) {
                                const sa = r.phases.system_analysis;
                                md += `## System Analysis

| Attribute | Value |
|-----------|-------|
| System Type | ${sa.system_type || 'Unknown'} |
| Data Classification | ${sa.data_classification || 'Unknown'} |
| Confidentiality | ${sa.confidentiality || 'Unknown'} |
| Integrity | ${sa.integrity || 'Unknown'} |
| Availability | ${sa.availability || 'Unknown'} |
| Recommended Profile | Profile ${sa.recommended_profile || 2} |

### Rationale

${sa.rationale || 'No rationale provided.'}

`;
                            }

                            // Coverage
                            if (r.phases.coverage) {
                                const cov = r.phases.coverage;

                                if (cov.full_coverage && cov.full_coverage.length > 0) {
                                    md += `## Controls with Full Evidence

| Control ID | Control Name | Family |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.full_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${ctrl.family} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (cov.partial_coverage && cov.partial_coverage.length > 0) {
                                    md += `## Controls with Partial Evidence (${cov.partial_coverage.length})

These controls have some evidence but need additional documentation:

| Control ID | Control Name | Family |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.partial_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${ctrl.family} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (cov.no_coverage && cov.no_coverage.length > 0) {
                                    md += `## Controls Missing Evidence (${cov.no_coverage.length})

**${cov.no_coverage.length} controls** require evidence documentation:

| Control ID | Control Name | Family |
|------------|--------------|--------|
`;
                                    for (const ctrl of cov.no_coverage) {
                                        md += `| ${ctrl.control_id} | ${ctrl.control_name} | ${ctrl.family} |\n`;
                                    }
                                    md += '\n';
                                }
                            }

                            // Recommendations
                            if (r.phases.recommendations) {
                                const rec = r.phases.recommendations;
                                md += `## Recommendations

`;
                                if (rec.high_priority && rec.high_priority.length > 0) {
                                    md += `### High Priority (${rec.high_priority.length})

| Control | Action | Suggested Evidence |
|---------|--------|-------------------|
`;
                                    for (const item of rec.high_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} | ${item.suggested_evidence || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.medium_priority && rec.medium_priority.length > 0) {
                                    md += `### Medium Priority (${rec.medium_priority.length})

| Control | Action |
|---------|--------|
`;
                                    for (const item of rec.medium_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.low_priority && rec.low_priority.length > 0) {
                                    md += `### Low Priority (${rec.low_priority.length})

| Control | Action |
|---------|--------|
`;
                                    for (const item of rec.low_priority) {
                                        md += `| ${item.control_id} | ${item.action || ''} |\n`;
                                    }
                                    md += '\n';
                                }

                                if (rec.next_steps && rec.next_steps.length > 0) {
                                    md += `### Next Steps

`;
                                    for (const step of rec.next_steps) {
                                        md += `- ${step}\n`;
                                    }
                                    md += '\n';
                                }
                            }
                        }
                    } else if (a.status === 'created') {
                        md += `## Assessment Status

This assessment has been created but not yet executed. Upload documents and run the assessment to generate results.

### Next Steps

- Upload relevant security documentation (policies, procedures, configurations)
- Include architecture diagrams and network documentation
- Run the assessment to analyze documents against ITSG-33 controls

`;
                    }

                    md += `---

*Generated by ITSG-33 Accreditation System*
`;

                    return md;
                },

                downloadMarkdown() {
                    const markdown = this.generateMarkdown();
                    const blob = new Blob([markdown], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const projectName = this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_');
                    a.download = `ITSG33_Assessment_${projectName}_${new Date().toISOString().split('T')[0]}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showToast('Markdown report downloaded!', 'success');
                },

                async downloadWord() {
                    if (!this.selectedAssessment) return;
                    const assessmentId = this.selectedAssessment.assessment_id;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/download/word`);
                        if (!response.ok) throw new Error('Download failed');
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ITSG33_Assessment_${this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast('Word document downloaded!', 'success');
                    } catch (error) {
                        this.showToast('Failed to download Word document', 'error');
                    }
                },

                async downloadPOAM() {
                    if (!this.selectedAssessment) return;
                    const assessmentId = this.selectedAssessment.assessment_id;
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/download/poam`);
                        if (!response.ok) throw new Error('Download failed');
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `POAM_${this.getProjectName().replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast('POA&M document downloaded!', 'success');
                    } catch (error) {
                        this.showToast('Failed to download POA&M', 'error');
                    }
                },

                async rerunAssessment(assessmentId) {
                    if (!confirm('This will rerun the assessment with all current documents. Previous results will be saved to history. Continue?')) {
                        return;
                    }
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/rerun`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.showToast(`Assessment rerun started. Previous runs: ${data.previous_runs}`, 'success');
                        await this.loadAssessments();
                    } catch (error) {
                        this.showToast('Failed to rerun assessment', 'error');
                    }
                },

                async viewHistory(assessmentId) {
                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/history`);
                        const data = await response.json();
                        this.assessmentHistory = data;
                        this.showHistoryModal = true;
                    } catch (error) {
                        this.showToast('Failed to load history', 'error');
                    }
                },

                addDocumentsToAssessment(assessment) {
                    this.addDocsAssessment = assessment;
                    this.addDocsFiles = [];
                    this.showAddDocsModal = true;
                },

                async handleAddDocsFiles(event) {
                    await this.uploadAddDocs(event.target.files);
                },

                async handleAddDocsDrop(event) {
                    this.dragover = false;
                    await this.uploadAddDocs(event.dataTransfer.files);
                },

                async uploadAddDocs(files) {
                    if (!this.addDocsAssessment) return;

                    const formData = new FormData();
                    for (const file of files) {
                        formData.append('files', file);
                    }

                    try {
                        const response = await fetch(`/api/v1/assessment/${this.addDocsAssessment.assessment_id}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        this.addDocsFiles = [...this.addDocsFiles, ...data.uploaded_files];
                        this.showToast(`${data.successful} file(s) uploaded`, 'success');
                    } catch (error) {
                        this.showToast('Failed to upload files', 'error');
                    }
                },

                async finishAddDocsAndRerun() {
                    if (!this.addDocsAssessment) return;

                    this.showAddDocsModal = false;
                    await this.rerunAssessment(this.addDocsAssessment.assessment_id);
                    this.addDocsAssessment = null;
                    this.addDocsFiles = [];
                },

                closeAddDocsModal() {
                    this.showAddDocsModal = false;
                    this.addDocsAssessment = null;
                    this.addDocsFiles = [];
                    this.loadAssessments();
                },

                getStatusClass(status) {
                    const classes = {
                        'created': 'bg-gray-100 text-gray-800',
                        'in_progress': 'bg-blue-100 text-blue-800',
                        'running': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'error': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    return new Date(dateString).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                },

                openRejectModal(control, action) {
                    this.rejectingControl = control;
                    this.rejectAction = action;  // 'reject_evidence' or 'not_applicable'
                    this.rejectReason = '';
                    this.rejectError = '';
                    this.showRejectModal = true;
                },

                closeRejectModal() {
                    this.showRejectModal = false;
                    this.rejectingControl = null;
                    this.rejectAction = 'reject_evidence';
                    this.rejectReason = '';
                    this.rejectError = '';
                },

                async confirmRejectAction() {
                    if (!this.rejectingControl || !this.selectedAssessment) return;

                    // Validate reason is provided
                    if (!this.rejectReason.trim()) {
                        this.rejectError = 'Please provide a reason';
                        return;
                    }
                    this.rejectError = '';

                    const assessmentId = this.selectedAssessment.assessment_id;
                    const controlId = this.rejectingControl.control_id;
                    const endpoint = this.rejectAction === 'not_applicable'
                        ? `/api/v1/assessment/${assessmentId}/control/${controlId}/not-applicable`
                        : `/api/v1/assessment/${assessmentId}/control/${controlId}/reject-evidence`;

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: this.rejectReason })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Action failed');
                        }

                        const data = await response.json();
                        const message = this.rejectAction === 'not_applicable'
                            ? `Control ${controlId} marked as not applicable`
                            : `Evidence for ${controlId} rejected`;
                        this.showToast(`${message}. Coverage: ${data.new_coverage_percentage}%`, 'success');

                        await this.viewAssessment(assessmentId);
                        this.closeRejectModal();
                    } catch (error) {
                        this.showToast(`Failed: ${error.message}`, 'error');
                    }
                },

                async restoreEvidence(controlId) {
                    if (!this.selectedAssessment) return;

                    const assessmentId = this.selectedAssessment.assessment_id;

                    try {
                        const response = await fetch(`/api/v1/assessment/${assessmentId}/control/${controlId}/restore`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Restore failed');
                        }

                        const data = await response.json();
                        this.showToast(`Control ${controlId} evidence restored. New coverage: ${data.new_coverage_percentage}%`, 'success');

                        // Refresh the assessment results
                        await this.viewAssessment(assessmentId);
                    } catch (error) {
                        this.showToast(`Failed to restore evidence: ${error.message}`, 'error');
                    }
                },

                getStrengthLabel(tier) {
                    const labels = {
                        1: 'System-Generated',
                        2: 'IaC',
                        3: 'Automated Test',
                        4: 'Code',
                        5: 'Screenshot',
                        6: 'Video',
                        7: 'Narrative'
                    };
                    return labels[tier] || 'Unknown';
                },

                getStrengthScore(tier) {
                    const scores = {1: 100, 2: 90, 3: 80, 4: 70, 5: 50, 6: 30, 7: 20};
                    return scores[tier] || 20;
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                }
            }
        }
    </script>
</body>
</html>
